<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Kedai Heula - Aplikasi manajemen bisnis kuliner lengkap: hitung HPP, kelola menu, analisa penjualan, dan strategi promo">
<title>Kedai Heula ‚Äì Jajanan Mantap Pisani</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&family=Fredoka+One&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root {
    --red: #E03027;
    --orange: #F47C20;
    --yellow: #F5C518;
    --dark: #1A1A1A;
    --bg: #FFF4E6;
    --card: #FFFAF5;
    --muted: #888;
    --border: #FFE4CC;
    --green: #27AE60;
    --light-red: #FFF0EF;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Nunito', sans-serif;
    background: var(--bg);
    color: var(--dark);
    min-height: 100vh;
  }

  /* HEADER */
  header {
    background: linear-gradient(135deg, var(--red) 0%, var(--orange) 60%, var(--yellow) 100%);
    padding: 24px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 4px 20px rgba(224,48,39,0.3);
  }

  header .logo-text {
    font-family: 'Fredoka One', cursive;
    font-size: 28px;
    color: white;
    text-shadow: 2px 2px 0px rgba(0,0,0,0.2);
    line-height: 1;
  }

  header .logo-sub {
    font-size: 12px;
    color: rgba(255,255,255,0.85);
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-top: 2px;
  }

  header .badge {
    margin-left: auto;
    background: rgba(255,255,255,0.2);
    color: white;
    font-size: 11px;
    font-weight: 800;
    padding: 6px 14px;
    border-radius: 20px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.3);
  }

  /* TABS */
  .tabs-wrapper {
    background: var(--card);
    padding: 20px 16px 16px;
    border-bottom: 1px solid var(--border);
  }
  .tab-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 12px;
    max-width: 640px;
    margin: 0 auto;
  }
  
  /* Mobile portrait - responsive */
  @media (max-width: 480px) {
    .tab-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
  }

  .tab-icon {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 16px;
    padding: 16px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Nunito', sans-serif;
  }
  .tab-icon:hover {
    border-color: var(--orange);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }
  .tab-icon.active {
    background: linear-gradient(135deg, #FFF8F0, #FFE4CC);
    border-color: var(--orange);
    box-shadow: 0 2px 8px rgba(244,124,32,0.2);
  }
  .ti-icon {
    font-size: 32px;
    line-height: 1;
  }
  .ti-label {
    font-size: 11px;
    font-weight: 700;
    color: var(--dark);
    text-align: center;
    line-height: 1.3;
  }

  /* MAIN */
  .main { padding: 24px; max-width: 960px; margin: 0 auto; }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* SECTION TITLE */
  .section-title {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    color: var(--red);
    margin-bottom: 6px;
  }

  .section-sub {
    font-size: 13px;
    color: var(--muted);
    margin-bottom: 20px;
    font-weight: 600;
  }

  /* CARD */
  .card {
    background: var(--card);
    border-radius: 16px;
    border: 2px solid var(--border);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.04);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .card-title {
    font-size: 14px;
    font-weight: 900;
    color: var(--dark);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  /* FORM ELEMENTS */
  label {
    display: block;
    font-size: 12px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
  }

  input[type="text"], input[type="number"], select {
    width: 100%;
    padding: 10px 14px;
    border: 2px solid var(--border);
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--dark);
    background: var(--bg);
    transition: border-color 0.2s;
    outline: none;
  }

  input:focus, select:focus {
    border-color: var(--orange);
    background: var(--card);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }

  .form-row.three { grid-template-columns: 2fr 1fr 1fr; }
  .form-row.four { grid-template-columns: 2fr 1fr 1fr 40px; align-items: end; }

  .form-group { margin-bottom: 12px; }

  /* BUTTONS */
  .btn {
    padding: 10px 20px;
    border-radius: 10px;
    font-family: 'Nunito', sans-serif;
    font-weight: 800;
    font-size: 13px;
    cursor: pointer;
    border: none;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--red), var(--orange));
    color: white;
    box-shadow: 0 3px 12px rgba(224,48,39,0.3);
  }

  .btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 5px 16px rgba(224,48,39,0.4);
  }

  .btn-secondary {
    background: var(--bg);
    color: var(--dark);
    border: 2px solid var(--border);
  }

  .btn-secondary:hover { border-color: var(--orange); color: var(--orange); }

  .btn-danger {
    background: var(--light-red);
    color: var(--red);
    border: 2px solid #FFCCCB;
    padding: 8px 10px;
    font-size: 15px;
  }

  .btn-danger:hover { background: #FFE0DF; }

  .btn-add {
    background: var(--card);
    color: var(--orange);
    border: 2px dashed var(--orange);
    width: 100%;
    justify-content: center;
    padding: 10px;
    margin-top: 8px;
  }

  .btn-add:hover { background: #FFF5EC; }

  /* BAHAN ITEM */
  .bahan-row {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(-6px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .bahan-header {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 36px;
    gap: 8px;
    margin-bottom: 6px;
  }

  .bahan-header span {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0 4px;
  }

  /* BIAYA ITEM */
  .biaya-row {
    display: grid;
    grid-template-columns: 2fr 1fr 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 8px;
  }

  /* RESULT BOX */
  .result-box {
    background: linear-gradient(135deg, var(--red) 0%, var(--orange) 100%);
    border-radius: 16px;
    padding: 24px;
    color: white;
    margin-bottom: 20px;
  }

  .result-box h3 {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    margin-bottom: 16px;
    opacity: 0.9;
  }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
  }

  .result-item {
    background: rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 14px;
    text-align: center;
    backdrop-filter: blur(4px);
    border: 1px solid rgba(255,255,255,0.2);
  }

  .result-item .label {
    font-size: 10px;
    font-weight: 800;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 6px;
    display: block;
    color: white;
  }

  .result-item .value {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    line-height: 1;
  }

  .result-item .sub {
    font-size: 10px;
    opacity: 0.7;
    margin-top: 4px;
  }

  /* BREAKDOWN TABLE */
  .breakdown-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
  }

  .breakdown-table th {
    text-align: left;
    padding: 10px 12px;
    font-size: 11px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    border-bottom: 2px solid var(--border);
  }

  .breakdown-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    font-weight: 600;
  }

  .breakdown-table tr:last-child td { border-bottom: none; }

  .breakdown-table tr:hover td { background: var(--bg); }

  .text-right { text-align: right; }

  .total-row td {
    font-weight: 900 !important;
    color: var(--red);
    border-top: 2px solid var(--border) !important;
    border-bottom: none !important;
  }

  /* PRICE SUGGESTION */
  .price-suggestion {
    background: #F0FDF4;
    border: 2px solid #86EFAC;
    border-radius: 14px;
    padding: 16px;
    margin-top: 12px;
  }

  .price-suggestion h4 {
    font-size: 13px;
    font-weight: 900;
    color: var(--green);
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .price-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
  }

  .price-option {
    background: var(--card);
    border-radius: 10px;
    padding: 12px;
    text-align: center;
    border: 2px solid #D1FAE5;
    cursor: pointer;
    transition: all 0.2s;
  }

  .price-option:hover {
    border-color: var(--green);
    transform: translateY(-1px);
  }

  .price-option .po-label {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .price-option .po-value {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--green);
  }

  .price-option .po-margin {
    font-size: 10px;
    color: var(--muted);
    margin-top: 2px;
    font-weight: 700;
  }

  /* SUMMARY TAB */
  .menu-card {
    background: var(--card);
    border-radius: 14px;
    border: 2px solid var(--border);
    padding: 16px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    transition: all 0.2s;
    cursor: pointer;
  }

  .menu-card:hover {
    border-color: var(--orange);
    box-shadow: 0 4px 12px rgba(244,124,32,0.1);
  }

  .menu-card .mc-left .mc-name {
    font-weight: 900;
    font-size: 16px;
  }

  .menu-card .mc-left .mc-category {
    font-size: 11px;
    color: var(--muted);
    font-weight: 700;
    text-transform: uppercase;
    margin-top: 2px;
  }

  .menu-card .mc-right {
    text-align: right;
  }

  .menu-card .mc-hpp {
    font-size: 13px;
    color: var(--muted);
    font-weight: 700;
  }

  .menu-card .mc-price {
    font-family: 'Fredoka One', cursive;
    font-size: 22px;
    color: var(--red);
  }

  .menu-card .mc-margin {
    font-size: 11px;
    color: var(--green);
    font-weight: 800;
  }

  .tag {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 10px;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-right: 4px;
  }

  .tag-takoyaki { background: #FFF3CD; color: #856404; }
  .tag-dimsum { background: #FFE0D0; color: #B94A00; }
  .tag-ayam { background: #D4EDDA; color: #155724; }
  .tag-lainnya { background: #E0E0FF; color: #3030B0; }

  /* SETTING HPP */
  .info-box {
    background: #FFF8E1;
    border: 2px solid #FFD54F;
    border-radius: 12px;
    padding: 14px;
    margin-bottom: 20px;
    font-size: 13px;
    font-weight: 600;
    color: #7B5800;
    display: flex;
    gap: 10px;
    align-items: flex-start;
  }

  .info-box .info-icon { font-size: 18px; flex-shrink: 0; }

  /* EMPTY STATE */
  .empty-state {
    text-align: center;
    padding: 48px 20px;
    color: var(--muted);
  }

  .empty-state .es-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; font-weight: 700; }
  .empty-state small { font-size: 12px; display: block; margin-top: 4px; }

  /* TOAST */
  .toast {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--dark);
    color: white;
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    opacity: 0;
    transform: translateY(10px);
    transition: all 0.3s;
    z-index: 100;
    pointer-events: none;
  }

  .toast.show { opacity: 1; transform: translateY(0); }

  /* RESPONSIVE */
  @media (max-width: 600px) {
    .main { padding: 16px; }
    .bahan-row { grid-template-columns: 1fr 1fr 36px; }
    .bahan-row .col-harga-satuan, .bahan-row .col-subtotal { display: none; }
    .bahan-header .col-harga-satuan, .bahan-header .col-subtotal { display: none; }
    .result-grid { grid-template-columns: 1fr 1fr; }
    .price-grid { grid-template-columns: 1fr; }
    .form-row.three { grid-template-columns: 1fr 1fr; }
    .form-row.four { grid-template-columns: 1fr 1fr 36px; }
  }

  /* Print / export note */
  .export-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  /* ===================== */
  /* PROMO TAB             */
  /* ===================== */
  .promo-type-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }

  .promo-type-btn {
    background: var(--card);
    border: 2px solid var(--border);
    border-radius: 14px;
    padding: 14px 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    font-family: 'Nunito', sans-serif;
  }

  .promo-type-btn:hover { border-color: var(--orange); }

  .promo-type-btn.active {
    border-color: var(--red);
    background: var(--light-red);
  }

  .promo-type-btn .pt-icon { font-size: 26px; margin-bottom: 6px; }
  .promo-type-btn .pt-label { font-size: 12px; font-weight: 800; color: var(--dark); }
  .promo-type-btn .pt-desc { font-size: 10px; color: var(--muted); margin-top: 2px; font-weight: 600; }

  .promo-panel { display: none; }
  .promo-panel.active { display: block; }

  .promo-result-box {
    border-radius: 16px;
    padding: 20px;
    margin-top: 16px;
  }

  .promo-result-box.profit { background: linear-gradient(135deg, #27AE60, #2ECC71); color: white; }
  .promo-result-box.warning { background: linear-gradient(135deg, #F39C12, #F1C40F); color: white; }
  .promo-result-box.danger { background: linear-gradient(135deg, #E03027, #F47C20); color: white; }

  .promo-result-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-top: 14px;
  }

  .promo-result-item {
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    padding: 12px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.3);
  }

  .promo-result-item .pri-label {
    font-size: 10px;
    font-weight: 800;
    opacity: 0.85;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
    display: block;
    color: white;
  }

  .promo-result-item .pri-value {
    font-family: 'Fredoka One', cursive;
    font-size: 20px;
    line-height: 1;
  }

  .promo-result-item .pri-sub {
    font-size: 10px;
    opacity: 0.75;
    margin-top: 3px;
  }

  .verdict-box {
    background: rgba(255,255,255,0.25);
    border-radius: 12px;
    padding: 14px;
    margin-top: 12px;
    font-size: 14px;
    font-weight: 700;
    border: 1px solid rgba(255,255,255,0.3);
    line-height: 1.6;
  }

  .verdict-box .verdict-title {
    font-family: 'Fredoka One', cursive;
    font-size: 16px;
    margin-bottom: 6px;
  }

  .slider-wrapper {
    margin: 12px 0;
  }

  .slider-wrapper input[type="range"] {
    width: 100%;
    accent-color: var(--red);
    height: 6px;
    border: none;
    background: none;
    padding: 0;
    cursor: pointer;
  }

  .slider-label {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    font-weight: 800;
    color: var(--muted);
    margin-top: 4px;
  }

  .slider-value {
    font-family: 'Fredoka One', cursive;
    font-size: 32px;
    color: var(--red);
    text-align: center;
    margin: 4px 0;
  }

  .beli-dapat-grid {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 10px;
    align-items: center;
    margin-bottom: 12px;
  }

  .beli-dapat-grid .separator {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--orange);
    text-align: center;
  }

  .bundle-item-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 60px 36px;
    gap: 8px;
    align-items: end;
    margin-bottom: 10px;
  }

  .bundle-item-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 60px 36px;
    gap: 8px;
    margin-bottom: 6px;
  }

  .bundle-item-header span {
    font-size: 10px;
    font-weight: 800;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 0 4px;
  }

  @media (max-width: 600px) {
    .promo-type-grid { grid-template-columns: 1fr 1fr; }
    .promo-result-grid { grid-template-columns: 1fr 1fr; }
    .bundle-item-row { grid-template-columns: 1fr 1fr 36px; }  }
  /* ===================== */
  /* MODAL                 */
  /* ===================== */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
    align-items: center;
    justify-content: center;
    padding: 16px;
    backdrop-filter: blur(4px);
  }

  .modal-box {
    background: var(--card);
    border-radius: 20px;
    width: 100%;
    max-width: 680px;
    max-height: 88vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    animation: modalIn 0.25s ease;
  }

  @keyframes modalIn {
    from { opacity:0; transform: scale(0.95) translateY(10px); }
    to { opacity:1; transform: scale(1) translateY(0); }
  }

  .modal-header {
    position: sticky;
    top: 0;
    background: var(--card);
    padding: 18px 20px 14px;
    border-bottom: 2px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1;
    border-radius: 20px 20px 0 0;
  }

  .modal-header .modal-title {
    font-family: 'Fredoka One', cursive;
    font-size: 18px;
    color: var(--red);
  }

  .modal-close {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 50%;
    width: 34px; height: 34px;
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s;
    font-family: sans-serif;
  }

  .modal-close:hover { background: var(--light-red); border-color: var(--red); }

  .modal-body { padding: 20px; }

  .modal-footer {
    position: sticky;
    bottom: 0;
    background: var(--card);
    padding: 14px 20px;
    border-top: 2px solid var(--border);
    display: flex;
    gap: 10px;
    justify-content: flex-end;
    border-radius: 0 0 20px 20px;
  }

  .edit-hpp-preview {
    background: var(--bg);
    border: 2px solid var(--border);
    border-radius: 10px;
    padding: 10px 14px;
    font-size: 13px;
    font-weight: 700;
    color: var(--dark);
    margin-top: 8px;
  }

  /* ===================== */
  /* PRINT                 */
  /* ===================== */
  #print-area { display: none; }

  @media print {
    header, .tabs-wrapper, .main, .modal-overlay, .toast, #print-area ~ * { display: none !important; }
    #print-area {
      display: block !important;
      font-family: Arial, sans-serif;
      color: #1A1A1A;
      font-size: 13px;
      padding: 0;
    }
    @page { margin: 15mm; size: A4; }

    #print-area .doc-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding-bottom: 14px;
      border-bottom: 3px solid #E03027;
      margin-bottom: 20px;
    }
    #print-area .brand { font-size: 20px; font-weight: 900; color: #E03027; }
    #print-area .brand-sub { font-size: 10px; color: #888; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; }
    #print-area .doc-meta { text-align: right; }
    #print-area .doc-meta .menu-name { font-size: 18px; font-weight: 900; }
    #print-area .doc-meta .meta-sub { font-size: 10px; color: #888; margin-top: 3px; }

    #print-area .summary-bar { display: grid; grid-template-columns: repeat(4,1fr); gap: 10px; margin-bottom: 20px; }
    #print-area .sum-box { background: #FFF8F0; border: 2px solid #F0E0CC; border-radius: 8px; padding: 10px; text-align: center; }
    #print-area .sum-label { font-size: 9px; font-weight: 700; color: #888; text-transform: uppercase; display: block; }
    #print-area .sum-value { font-size: 15px; font-weight: 900; color: #E03027; display: block; margin-top: 3px; }
    #print-area .sum-sub { font-size: 9px; color: #888; display: block; margin-top: 1px; }

    #print-area h3 { font-size: 13px; font-weight: 900; color: #E03027; margin: 18px 0 8px; padding-bottom: 5px; border-bottom: 2px solid #F0E0CC; }
    #print-area h3:first-of-type { margin-top: 0; }
    #print-area table { width: 100%; border-collapse: collapse; margin-bottom: 4px; }
    #print-area thead tr { background: #F47C20 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area thead th { padding: 7px 9px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    #print-area tbody tr:nth-child(even) { background: #FFF8F0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area tbody td { padding: 7px 9px; border-bottom: 1px solid #F0E0CC; }
    #print-area .pr-num { text-align: right; }
    #print-area .total-row td { background: #FFF3E0 !important; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    #print-area .harga-section { margin-top: 20px; }
    #print-area .harga-title { font-size: 13px; font-weight: 900; color: #E03027; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 2px solid #F0E0CC; }
    #print-area .harga-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
    #print-area .harga-box { border-radius: 8px; padding: 10px; text-align: center; border: 2px solid; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    #print-area .harga-box.ekonomis { background: #FFF9E6 !important; border-color: #F5C518; }
    #print-area .harga-box.standar  { background: #E8F5E9 !important; border-color: #27AE60; }
    #print-area .harga-box.premium  { background: #FFF0EF !important; border-color: #E03027; }
    #print-area .hb-label { font-size: 9px; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 4px; }
    #print-area .ekonomis .hb-label { color: #B8860B; }
    #print-area .standar  .hb-label { color: #1B5E20; }
    #print-area .premium  .hb-label { color: #E03027; }
    #print-area .hb-value { font-size: 17px; font-weight: 900; display: block; margin-bottom: 2px; }
    #print-area .hb-margin { font-size: 10px; color: #888; display: block; }

    #print-area .doc-footer { margin-top: 24px; padding-top: 10px; border-top: 2px solid #F0E0CC; display: flex; justify-content: space-between; font-size: 10px; color: #aaa; }
  }
</style>
</head>
<body>

<header>
  <div>
    <div class="logo-text">üç± Kedai Heula</div>
    <div class="logo-sub">Manajemen Bisnis Kuliner ‚Äì Jajanan Mantap Pisan!</div>
  </div>
  <div class="badge">BETA</div>
</header>

<div class="tabs-wrapper">
  <div class="tab-grid">
    <button class="tab-icon active" onclick="switchTab('hitung')">
      <div class="ti-icon">üßÆ</div>
      <div class="ti-label">Hitung HPP</div>
    </button>
    <button class="tab-icon" onclick="switchTab('ringkasan')">
      <div class="ti-icon">üìã</div>
      <div class="ti-label">Ringkasan Menu</div>
    </button>
    <button class="tab-icon" onclick="switchTab('laporan')">
      <div class="ti-icon">üìä</div>
      <div class="ti-label">Laporan</div>
    </button>
    <button class="tab-icon" onclick="switchTab('promo')">
      <div class="ti-icon">üè∑Ô∏è</div>
      <div class="ti-label">Promo</div>
    </button>
    <button class="tab-icon" onclick="switchTab('panduan')">
      <div class="ti-icon">üìñ</div>
      <div class="ti-label">Panduan</div>
    </button>
  </div>
</div>

<div class="main">

  <!-- TAB HITUNG HPP -->
  <div id="tab-hitung" class="tab-content active">

    <div class="info-box">
      <span class="info-icon">üí°</span>
      <div>
        <strong>Cara pakai:</strong> Isi info produk ‚Üí tambah bahan-bahan ‚Üí tambah biaya operasional ‚Üí klik <strong>Hitung HPP</strong>. Hasilnya langsung tersimpan dan bisa diakses di tab <strong>Ringkasan Menu</strong>, <strong>Laporan Penjualan</strong>, dan <strong>Kalkulator Promo</strong>!
      </div>
    </div>

    <!-- INFO PRODUK -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üì¶ Info Produk</div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="nama-menu" placeholder="cth: Takoyaki Original" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="kategori-menu">
            <option value="takoyaki">üêô Takoyaki</option>
            <option value="dimsum">ü•ü Dimsum</option>
            <option value="ayam">üçó Ayam Crispy</option>
            <option value="lainnya">üç± Lainnya</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label>Foto Menu (Opsional)</label>
        <input type="file" id="foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-foto" style="margin-top:8px;"></div>
      </div>
      <div class="form-row three">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="porsi" value="6" min="1" placeholder="6" />
        </div>
        <div class="form-group">
          <label>Sat. Porsi</label>
          <select id="satuan-porsi">
            <option>pcs</option>
            <option>porsi</option>
            <option>box</option>
            <option>pack</option>
          </select>
        </div>
        <div class="form-group">
          <label>Kemasan (Rp)</label>
          <input type="number" id="biaya-kemasan" value="500" min="0" placeholder="500" />
        </div>
      </div>
    </div>

    <!-- BAHAN BAKU -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">üßÖ Bahan Baku</div>
      </div>

      <div class="bahan-header">
        <span>Nama Bahan</span>
        <span>Qty Dipakai</span>
        <span class="col-harga-satuan">Harga Beli (Rp)</span>
        <span class="col-harga-satuan">Ukuran Beli</span>
        <span class="col-subtotal"></span>
      </div>

      <div id="bahan-list"></div>

      <button class="btn btn-add" onclick="tambahBahan()">
        Ôºã Tambah Bahan
      </button>
    </div>

    <!-- BIAYA OPERASIONAL -->
    <div class="card">
      <div class="card-header">
        <div class="card-title">‚öôÔ∏è Biaya Operasional per Batch</div>
      </div>

      <div id="biaya-list"></div>

      <button class="btn btn-add" onclick="tambahBiaya()">
        Ôºã Tambah Biaya (gas, listrik, dll)
      </button>
    </div>

    <!-- TOMBOL HITUNG -->
    <div style="display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="hitungHPP()">
        üßÆ Hitung HPP Sekarang
      </button>
      <button class="btn btn-secondary" onclick="resetForm()">
        üîÑ Reset Form
      </button>
    </div>

    <!-- HASIL -->
    <div id="hasil-section" style="display:none;">

      <div class="result-box">
        <h3>üìä Hasil Kalkulasi HPP</h3>
        <div class="result-grid">
          <div class="result-item">
            <span class="label">Total Biaya Batch</span>
            <div class="value" id="res-total-batch">Rp 0</div>
            <div class="sub" id="res-batch-info">untuk 6 pcs</div>
          </div>
          <div class="result-item">
            <span class="label">HPP per Pcs</span>
            <div class="value" id="res-hpp">Rp 0</div>
            <div class="sub">harga pokok produksi</div>
          </div>
          <div class="result-item">
            <span class="label">Min. BEP Harga Jual</span>
            <div class="value" id="res-bep">Rp 0</div>
            <div class="sub">HPP + platform fee 30%</div>
          </div>
        </div>
      </div>

      <!-- BREAKDOWN -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">üîç Detail Breakdown Biaya</div>
        </div>
        <table class="breakdown-table">
          <thead>
            <tr>
              <th>Komponen</th>
              <th>Keterangan</th>
              <th class="text-right">Biaya (Rp)</th>
              <th class="text-right">%</th>
            </tr>
          </thead>
          <tbody id="breakdown-body"></tbody>
        </table>
      </div>

      <!-- SARAN HARGA JUAL -->
      <div class="price-suggestion">
        <h4>üí° Rekomendasi Harga Jual</h4>
        
        <!-- Header kolom -->
        <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;font-size:11px;font-weight:700;color:#666;">
          <div></div>
          <div style="text-align:center;">üè™ OFFLINE</div>
          <div style="text-align:center;">üì± ONLINE<br><span style="font-size:9px;font-weight:400;">(GoFood/Shopee)</span></div>
        </div>

        <!-- Row 1: Ekonomis -->
        <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;">
          <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
            üü° EKONOMIS<br><span style="font-size:10px;font-weight:400;color:#999;">Margin 30%</span>
          </div>
          <div class="price-option" onclick="pilihHarga(this, 'offline')" data-margin="30" style="margin:0;">
            <div class="po-value" id="harga-30-offline">Rp 0</div>
          </div>
          <div class="price-option" onclick="pilihHarga(this, 'online')" data-margin="30" style="margin:0;">
            <div class="po-value" id="harga-30-online">Rp 0</div>
          </div>
        </div>

        <!-- Row 2: Standar (recommended) -->
        <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;">
          <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
            üü¢ STANDAR<br><span style="font-size:10px;font-weight:400;color:#999;">Margin 50%</span>
          </div>
          <div class="price-option recommended" onclick="pilihHarga(this, 'offline')" data-margin="50" style="margin:0;border:2px solid #4CAF50;">
            <div class="po-value" id="harga-50-offline">Rp 0</div>
          </div>
          <div class="price-option recommended" onclick="pilihHarga(this, 'online')" data-margin="50" style="margin:0;border:2px solid #4CAF50;">
            <div class="po-value" id="harga-50-online">Rp 0</div>
          </div>
        </div>

        <!-- Row 3: Premium -->
        <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;">
          <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
            üî• PREMIUM<br><span style="font-size:10px;font-weight:400;color:#999;">Margin 70%</span>
          </div>
          <div class="price-option" onclick="pilihHarga(this, 'offline')" data-margin="70" style="margin:0;">
            <div class="po-value" id="harga-70-offline">Rp 0</div>
          </div>
          <div class="price-option" onclick="pilihHarga(this, 'online')" data-margin="70" style="margin:0;">
            <div class="po-value" id="harga-70-online">Rp 0</div>
          </div>
        </div>

        <div style="font-size:11px;color:#666;margin-top:10px;padding-top:10px;border-top:1px solid #ddd;">
          ‚ÑπÔ∏è <strong>Harga online 25% lebih tinggi</strong> untuk cover platform fee ~20%.
        </div>
      </div>

      <div style="margin-top:16px;display:flex;gap:12px;flex-wrap:wrap;">
        <button class="btn btn-primary" onclick="simpanMenu()">
          üíæ Simpan ke Ringkasan Menu
        </button>
        <button class="btn btn-secondary" onclick="konfirmasiMenuBaru()">
          ‚ûï Input Menu Baru
        </button>
        <button class="btn btn-secondary" onclick="cetakHasil()">
          üñ®Ô∏è Cetak / Export
        </button>
      </div>
    </div>
  </div>

  <!-- TAB RINGKASAN -->
  <div id="tab-ringkasan" class="tab-content">
    <div class="section-title">üìã Ringkasan Semua Menu</div>
    <div class="section-sub">Semua menu yang sudah dihitung HPP-nya ada di sini.</div>

    <!-- CLOUD SYNC BAR -->
    <div id="sync-bar" style="background:#FFFAF5;border:2px solid var(--border);border-radius:14px;padding:14px 16px;margin-bottom:16px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
      <div style="flex:1;min-width:160px;">
        <div style="font-size:13px;font-weight:800;color:var(--dark);">‚òÅÔ∏è Cloud Backup (Google Sheets)</div>
        <div id="sync-status" style="font-size:11px;color:var(--muted);font-weight:700;margin-top:2px;">Belum dikonfigurasi</div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="bukaSyncConfig()">‚öôÔ∏è Setup</button>
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="syncKeSheets()" id="btn-sync">‚¨ÜÔ∏è Backup</button>
        <button class="btn btn-secondary" style="font-size:12px;padding:8px 14px;" onclick="restoreFromSheets()" id="btn-restore">‚¨áÔ∏è Restore</button>
      </div>
    </div>

    <div id="ringkasan-list">
      <div class="empty-state">
        <div class="es-icon">üç±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>
    </div>
  </div>

  <!-- MODAL SYNC CONFIG -->
  <div class="modal-overlay" id="modal-sync" onclick="if(event.target===this)tutupSyncConfig()">
    <div class="modal-box" style="max-width:520px;">
      <div class="modal-header">
        <div class="modal-title">‚öôÔ∏è Setup Cloud Backup</div>
        <button class="modal-close" onclick="tutupSyncConfig()">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="info-box" style="background:#E3F2FD;border-left:4px solid #2196F3;padding:12px 14px;border-radius:10px;margin-bottom:16px;font-size:13px;">
          <span style="font-size:18px;">üí°</span>
          <div style="margin-left:10px;">Data kamu akan disimpan ke <strong>Google Sheets</strong> milikmu sendiri via Google Apps Script. Gratis, tidak ada pihak ketiga yang akses data kamu.</div>
        </div>

        <div style="font-size:13px;font-weight:800;margin-bottom:10px;color:var(--dark);">Langkah setup (sekali saja):</div>
        <ol style="font-size:13px;color:#444;padding-left:18px;line-height:2;">
          <li>Buka <a href="https://sheets.new" target="_blank" style="color:var(--red);font-weight:700;">sheets.new</a> untuk buat Google Sheet baru</li>
          <li>Di Sheet, klik menu <strong>Extensions ‚Üí Apps Script</strong></li>
          <li>Hapus kode yang ada, paste kode dari file <code>apps-script.gs</code></li>
          <li>Klik <strong>Deploy ‚Üí New deployment ‚Üí Web app</strong></li>
          <li>Execute as: <strong>Me</strong> ¬∑ Who has access: <strong>Anyone</strong> ‚Üí Deploy</li>
          <li>Copy URL yang muncul, paste di bawah ini</li>
        </ol>

        <div class="form-group" style="margin-top:14px;">
          <label style="font-size:13px;font-weight:800;">URL Apps Script Web App</label>
          <input type="text" id="sheets-url-input"
            placeholder="https://script.google.com/macros/s/xxx/exec"
            style="width:100%;padding:10px 12px;border-radius:8px;border:2px solid var(--border);font-size:13px;margin-top:6px;outline:none;" />
        </div>

        <!-- Debug Log -->
        <div id="debug-log" style="display:none;margin-top:12px;padding:10px;background:#1E1E2E;color:#CDD6F4;border-radius:8px;font-family:monospace;font-size:11px;max-height:150px;overflow-y:auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="tutupSyncConfig()">Batal</button>
        <button class="btn btn-primary" onclick="simpanSyncConfig()">üíæ Simpan & Test</button>
      </div>
    </div>
  </div>

  <!-- TAB LAPORAN PENJUALAN -->
  <div id="tab-laporan" class="tab-content">
    <div class="section-title">üìä Laporan Penjualan</div>
    <div class="section-sub">Catat transaksi harian dan lihat profit bisnis kamu</div>

    <!-- ACTION BUTTONS -->
    <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="exportLaporanPDF()" style="font-size:13px;padding:10px 16px;">
        üìÑ Export PDF
      </button>
      <button class="btn btn-secondary" onclick="syncTransaksiKeSheets()" style="font-size:13px;padding:10px 16px;">
        ‚¨ÜÔ∏è Backup Transaksi
      </button>
      <button class="btn btn-secondary" onclick="restoreTransaksiFromSheets()" style="font-size:13px;padding:10px 16px;">
        ‚¨áÔ∏è Restore Transaksi
      </button>
    </div>

    <!-- PERIOD SELECTOR -->
    <div class="card" style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;margin-bottom:16px;">
        <div style="font-size:15px;font-weight:800;color:var(--dark);">üìÖ Periode Laporan</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('hari')" id="btn-period-hari" style="font-size:12px;padding:6px 14px;">Hari Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('minggu')" id="btn-period-minggu" style="font-size:12px;padding:6px 14px;">7 Hari</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('bulan')" id="btn-period-bulan" style="font-size:12px;padding:6px 14px;">Bulan Ini</button>
          <button class="btn btn-secondary" onclick="setPeriodeLaporan('semua')" id="btn-period-semua" style="font-size:12px;padding:6px 14px;">Semua</button>
        </div>
      </div>
      
      <!-- SUMMARY CARDS -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
        <div style="background:linear-gradient(135deg,#27AE60,#2ECC71);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üí∞ Total Profit</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-profit">Rp 0</div>
        </div>
        <div style="background:linear-gradient(135deg,#2980B9,#3498DB);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üì¶ Total Transaksi</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-transaksi">0</div>
        </div>
        <div style="background:linear-gradient(135deg,#E67E22,#F39C12);border-radius:12px;padding:14px;color:white;">
          <div style="font-size:10px;opacity:0.85;font-weight:800;text-transform:uppercase;">üç± Item Terjual</div>
          <div style="font-family:'Fredoka One',cursive;font-size:20px;margin-top:4px;" id="lap-item">0</div>
        </div>
      </div>
    </div>

    <!-- BREAKDOWN PER MENU -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">üìä Breakdown per Menu</div>
      <div id="breakdown-menu"></div>
    </div>

    <!-- INPUT TRANSAKSI -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">‚ûï Catat Transaksi Baru</div>
      
      <div class="info-box" style="background:#E8F5E9;border-left:4px solid var(--green);padding:10px 12px;border-radius:10px;margin-bottom:14px;font-size:12px;">
        <span style="font-size:16px;">üí°</span>
        <div style="margin-left:8px;"><strong>Input transaksi masa lalu:</strong> Kamu bisa input transaksi kemarin atau tanggal lain dengan ganti tanggal secara manual. Gunakan tombol shortcut <strong>Kemarin</strong> untuk cepat.</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Tanggal</label>
          <div style="display:flex;gap:6px;align-items:stretch;">
            <input type="date" id="transaksi-tanggal" style="flex:1;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('kemarin')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Kemarin</button>
            <button class="btn btn-secondary" onclick="setTanggalTransaksi('hari-ini')" style="font-size:11px;padding:6px 10px;white-space:nowrap;">Hari Ini</button>
          </div>
        </div>
        <div class="form-group">
          <label>Menu</label>
          <select id="transaksi-menu" onchange="isiHargaTransaksi()" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;">
            <option value="">-- Pilih Menu --</option>
          </select>
        </div>
      </div>

      <div class="form-row three">
        <div class="form-group">
          <label>Jumlah (pcs)</label>
          <input type="number" id="transaksi-qty" min="1" value="1" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
        <div class="form-group">
          <label>HPP/pcs</label>
          <input type="number" id="transaksi-hpp" readonly style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;background:#F5F5F5;" />
        </div>
        <div class="form-group">
          <label>Harga Jual/pcs</label>
          <input type="number" id="transaksi-harga" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        </div>
      </div>

      <div style="margin-top:12px;">
        <button class="btn btn-primary" onclick="simpanTransaksi()">üíæ Simpan Transaksi</button>
      </div>
    </div>

    <!-- CHART -->
    <div class="card" style="margin-bottom:16px;">
      <div class="card-title" style="margin-bottom:12px;">üìà Tren Profit</div>
      <canvas id="chart-profit" style="max-height:280px;"></canvas>
    </div>

    <!-- TABEL TRANSAKSI -->
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">üìã Riwayat Transaksi</div>
      <div id="tabel-transaksi" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- TAB PROMO -->
  <div id="tab-promo" class="tab-content">

    <div class="section-title">üè∑Ô∏è Kalkulator Promo</div>
    <div class="section-sub">Hitung apakah promo kamu masih untung atau malah boncos!</div>

    <div class="info-box">
      <span class="info-icon">üí°</span>
      <div>
        Pilih jenis promo di bawah, isi angkanya, dan kalkulator akan langsung tunjukkin <strong>profit/rugi per transaksi</strong> + rekomendasi apakah promo layak dijalankan.
      </div>
    </div>

    <!-- PILIH TIPE PROMO -->
    <div class="promo-type-grid">
      <div class="promo-type-btn active" onclick="switchPromo('diskon', this)">
        <div class="pt-icon">%</div>
        <div class="pt-label">Diskon %</div>
        <div class="pt-desc">Potong harga sekian persen</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('bundling', this)">
        <div class="pt-icon">üì¶</div>
        <div class="pt-label">Bundling</div>
        <div class="pt-desc">Paket beberapa menu</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('beli-dapat', this)">
        <div class="pt-icon">üéÅ</div>
        <div class="pt-label">Beli X Gratis Y</div>
        <div class="pt-desc">Gratis item/cashback</div>
      </div>
      <div class="promo-type-btn" onclick="switchPromo('poster', this)">
        <div class="pt-icon">üé®</div>
        <div class="pt-label">Generate Poster</div>
        <div class="pt-desc">Poster Instagram siap pakai</div>
      </div>
    </div>

    <!-- PANEL: DISKON % -->
    <div id="panel-diskon" class="promo-panel active">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">‚úÇÔ∏è Simulasi Diskon Persen</div>

        <!-- PILIH DARI RINGKASAN -->
        <div class="form-group" style="margin-bottom:14px;">
          <label>Pilih Menu dari Ringkasan <span style="color:var(--orange)">‚òÖ</span></label>
          <div style="display:flex;gap:10px;align-items:center;">
            <select id="d-pilih-menu" onchange="isiDariRingkasan()" style="flex:1;">
              <option value="">‚Äî Pilih menu yang sudah dihitung HPP-nya ‚Äî</option>
            </select>
            <button class="btn btn-secondary" onclick="refreshDropdownDiskon()" title="Refresh daftar menu" style="padding:10px 14px;white-space:nowrap;">üîÑ Refresh</button>
          </div>
        </div>

        <!-- INFO MENU TERPILIH -->
        <div id="d-menu-info" style="display:none; margin-bottom:14px;">
          <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:12px;padding:14px 18px;color:white;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
            <div>
              <div style="font-family:'Fredoka One',cursive;font-size:18px;" id="d-menu-info-nama">‚Äî</div>
              <div style="font-size:11px;opacity:0.85;margin-top:2px;" id="d-menu-info-kategori">‚Äî</div>
            </div>
            <div style="display:flex;gap:16px;flex-wrap:wrap;">
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP/pcs</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hpp">‚Äî</div>
              </div>
              <div style="text-align:center;">
                <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
                <div style="font-family:'Fredoka One',cursive;font-size:20px;" id="d-menu-info-hj">‚Äî</div>
              </div>
            </div>
          </div>
        </div>

        <!-- ATAU INPUT MANUAL -->
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <span style="font-size:11px;font-weight:800;color:var(--muted);white-space:nowrap;">atau input manual</span>
          <div style="flex:1;height:1px;background:var(--border);"></div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nama Menu</label>
            <input type="text" id="d-nama" placeholder="cth: Takoyaki Original" />
          </div>
          <div class="form-group">
            <label>HPP per Pcs (Rp) <span style="color:var(--orange)">*</span></label>
            <input type="number" id="d-hpp" placeholder="5000" min="0" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Harga Jual Normal (Rp)</label>
            <input type="number" id="d-harga-normal" placeholder="12000" min="0" oninput="hitungDiskon()" />
          </div>
          <div class="form-group">
            <label>Platform Fee (%) ‚Äî GoFood/Shopee</label>
            <input type="number" id="d-platform-fee" value="20" min="0" max="100" oninput="hitungDiskon()" />
          </div>
        </div>

        <div class="form-group">
          <label>Besar Diskon: <span id="d-diskon-label" style="color:var(--red);font-size:16px;font-family:'Fredoka One',cursive;">20%</span></label>
          <div class="slider-wrapper">
            <input type="range" id="d-diskon" min="5" max="70" value="20" step="5" oninput="updateDiskonSlider(); hitungDiskon();" />
            <div class="slider-label"><span>5%</span><span>70%</span></div>
          </div>
        </div>

        <div id="diskon-result" style="display:none;"></div>
      </div>
    </div>

    <!-- PANEL: BUNDLING -->
    <div id="panel-bundling" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">üì¶ Simulasi Harga Bundling / Paket</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <div>Pilih item dari <strong>Ringkasan Menu</strong> ‚Äî HPP dan harga jual otomatis terisi.</div>
        </div>

        <div class="bundle-item-header">
          <span>Pilih / Nama Item</span>
          <span>HPP/pcs</span>
          <span>Harga Jual</span>
          <span>Qty</span>
          <span></span>
        </div>
        <div id="bundle-list"></div>
        <button class="btn btn-add" onclick="tambahBundleItem()">Ôºã Tambah Item dari Ringkasan</button>

        <div id="bundling-result" style="margin-top:16px;"></div>
      </div>
    </div>

    <!-- PANEL: BELI X GRATIS Y -->
    <div id="panel-beli-dapat" class="promo-panel">
      <div class="card">
        <div class="card-title" style="margin-bottom:16px;">üéÅ Simulasi Beli X Gratis Y</div>

        <div class="info-box" style="margin-bottom:16px;">
          <span class="info-icon">‚ÑπÔ∏è</span>
          <div>Pilih menu dari <strong>Ringkasan Menu</strong> untuk auto-fill HPP dan harga jual.</div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label>Pilih Menu (opsional)</label>
          <select id="bg-menu-select" onchange="isiBeliGratis()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;">
            <option value="">üîç Pilih dari Ringkasan Menu...</option>
          </select>
        </div>

        <div class="beli-dapat-grid">
          <div class="form-group">
            <label>Beli (pcs)</label>
            <input type="number" id="bg-beli" value="2" min="1" oninput="hitungBeliGratis()" />
          </div>
          <div class="separator">‚Üí Gratis</div>
          <div class="form-group">
            <label>Gratis (pcs)</label>
            <input type="number" id="bg-gratis" value="1" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div class="form-group" style="margin-bottom:16px;">
          <label style="font-weight:700;margin-bottom:8px;display:block;">Channel Penjualan</label>
          <select id="bg-channel" onchange="toggleBeliGratisChannel()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;background:var(--card);">
            <option value="offline">üè™ Offline (tanpa platform fee)</option>
            <option value="online">üì± Online (GoFood/Shopee/Grab)</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>HPP per Pcs (Rp)</label>
            <input type="number" id="bg-hpp" placeholder="5000" min="0" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Harga Jual Normal per Pcs (Rp)</label>
            <input type="number" id="bg-harga" placeholder="12000" min="0" oninput="hitungBeliGratis()" />
          </div>
        </div>
        <div class="form-row" id="bg-fee-row" style="display:grid;">
          <div class="form-group">
            <label>Platform Fee (%) ‚Äî GoFood/Shopee</label>
            <input type="number" id="bg-fee" value="20" min="0" max="100" oninput="hitungBeliGratis()" />
          </div>
          <div class="form-group">
            <label>Estimasi Transaksi per Hari</label>
            <input type="number" id="bg-transaksi" value="10" min="1" oninput="hitungBeliGratis()" />
          </div>
        </div>

        <div id="beli-gratis-result" style="display:none; margin-top:16px;"></div>
      </div>
    </div>

  </div>

  <!-- PANEL: GENERATE POSTER -->
  <div id="panel-poster" class="promo-panel">
    <div class="card">
      <div class="card-title" style="margin-bottom:16px;">üé® Generate Poster Instagram</div>
      
      <div class="info-box" style="margin-bottom:16px;">
        <span class="info-icon">‚ú®</span>
        <div>Buat poster promo siap pakai untuk Instagram/Facebook dengan logo Kedai Heula. Pilih jenis promo, isi detail, lalu download!</div>
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label style="font-weight:700;">Jenis Promo</label>
        <select id="poster-type" onchange="updatePosterPreview()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;background:var(--card);">
          <option value="diskon">‚úÇÔ∏è Diskon Persen</option>
          <option value="bundling">üì¶ Paket Bundling</option>
          <option value="beli-gratis">üéÅ Beli X Gratis Y</option>
        </select>
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label style="font-weight:700;">Judul Promo</label>
        <input type="text" id="poster-title" placeholder="cth: DISKON 30% SEMUA MENU!" oninput="updatePosterPreview()" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:700;width:100%;background:var(--card);" />
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label style="font-weight:700;">Detail Promo</label>
        <textarea id="poster-detail" placeholder="cth: Berlaku untuk semua jenis Takoyaki & Dimsum&#10;Periode: 15-28 Feb 2026&#10;Pembelian min. Rp 50.000" oninput="updatePosterPreview()" rows="4" style="padding:12px;border-radius:12px;border:2px solid var(--border);font-size:14px;font-weight:600;width:100%;background:var(--card);resize:vertical;"></textarea>
      </div>

      <div style="background:var(--bg);border-radius:12px;padding:16px;margin-bottom:16px;">
        <div style="font-weight:700;margin-bottom:12px;font-size:14px;">üì± Preview Poster (1080x1080px)</div>
        <canvas id="poster-canvas" width="1080" height="1080" style="width:100%;max-width:400px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></canvas>
      </div>

      <button class="btn btn-primary" onclick="downloadPoster()" style="width:100%;padding:14px;font-size:15px;">
        üì• Download Poster PNG
      </button>
    </div>
  </div>

  <!-- TAB PANDUAN -->
  <div id="tab-panduan" class="tab-content">
    <div class="section-title">üìñ Panduan Penggunaan</div>
    <div class="section-sub">Tips dan penjelasan cara pakai kalkulator ini.</div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">Apa itu HPP?</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        <strong>HPP (Harga Pokok Produksi)</strong> adalah total biaya yang dikeluarkan untuk memproduksi satu porsi/pcs makanan. HPP mencakup:
      </p>
      <br>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>üí∞ <strong>Bahan baku</strong> ‚Äì semua bahan yang dipakai</li>
        <li>üì¶ <strong>Kemasan</strong> ‚Äì box, plastik, tusuk, dll</li>
        <li>‚öôÔ∏è <strong>Biaya operasional</strong> ‚Äì gas, listrik, dll per batch</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üßÆ Rumus Dasar</div>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>üìå <strong>Total Biaya Batch</strong> = Œ£(Biaya Bahan) + Kemasan + Biaya Operasional</div>
        <div>üìå <strong>HPP per Pcs</strong> = Total Biaya Batch √∑ Jumlah Porsi</div>
        <div>üìå <strong>Harga Jual</strong> = HPP √∑ (1 - margin%)</div>
        <div>üìå <strong>BEP Online</strong> = HPP √∑ (1 - 30%) ‚Üí karena GoFood/ShopeeFood potong ~20-30%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üí° Tips Buat Kedai Heula</div>
      <ul style="font-size:14px;line-height:2;color:#444;font-weight:600;padding-left:20px;">
        <li>üêô <strong>Takoyaki:</strong> HPP biasanya Rp 2.500‚Äì4.000/pcs. Jual Rp 7.000‚Äì12.000/pcs (isi 6‚Äì8) oke!</li>
        <li>ü•ü <strong>Dimsum:</strong> HPP bervariasi sesuai isian. Mentai sauce nambahin cost tapi bisa jual lebih mahal.</li>
        <li>üçó <strong>Ayam Crispy:</strong> Perhatiin yield (susut saat goreng ~20-30% dari berat mentah).</li>
        <li>üì¶ <strong>Kemasan:</strong> Jangan anggap remeh! Kemasan keren = boleh jual lebih mahal.</li>
        <li>üõµ <strong>Platform fee:</strong> GoFood/ShopeeFood potong 20-30%. Harga di app harus udah cover ini!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üì± Cara Hitung Bahan yang Beli Kemasan Besar</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Contoh: Tepung terigu beli 1 kg = Rp 12.000, tapi satu batch cuma pakai 150 gram.
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2;">
        <div>Isi kolom <strong>Qty Dipakai</strong> = 150</div>
        <div>Isi kolom <strong>Harga Beli</strong> = 12000</div>
        <div>Isi kolom <strong>Ukuran Beli</strong> = 1000 (gram)</div>
        <div>‚Üí Kalkulator otomatis hitung: 150/1000 √ó 12.000 = <strong>Rp 1.800</strong></div>
      </div>
    </div>

    <!-- ======================== -->
    <!-- TIPS KALKULATOR PROMO   -->
    <!-- ======================== -->
    <div style="margin-top:28px;">
      <div class="section-title">üè∑Ô∏è Panduan Kalkulator Promo</div>
      <div class="section-sub">Tips biar promo Kedai Heula tetap untung, bukan boncos!</div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üß† Prinsip Dasar Promo yang Sehat</div>
      <p style="font-size:14px;line-height:1.7;color:#444;font-weight:600;">
        Promo bukan berarti harus rugi. Tujuannya adalah menarik perhatian pelanggan baru atau mendorong volume penjualan, tapi margin tetap harus dijaga. Aturan praktisnya:
      </p>
      <br>
      <div style="background:var(--bg);border-radius:10px;padding:16px;font-size:13px;font-weight:700;line-height:2.2;">
        <div>üü¢ <strong>Margin ‚â• 20%</strong> setelah promo ‚Üí Aman, bisa jalan terus</div>
        <div>üü° <strong>Margin 10‚Äì20%</strong> ‚Üí Hati-hati, batasi durasi 7‚Äì14 hari</div>
        <div>üî¥ <strong>Margin &lt; 10% atau minus</strong> ‚Üí Evaluasi ulang, promo ini boncos!</div>
        <div>üìå <strong>Selalu hitung platform fee</strong> (GoFood/Shopee ~20‚Äì30%) sebelum tentukan harga promo</div>
      </div>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">‚úÇÔ∏è Tips Promo Diskon %</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Diskon 10‚Äì20%</strong> ‚Üí Paling aman, masih untung lumayan. Cocok buat promo rutin mingguan.</li>
        <li><strong>Diskon 25‚Äì30%</strong> ‚Üí Menarik perhatian tapi pastiin HPP-mu sudah efisien. Cek dulu di kalkulator.</li>
        <li><strong>Diskon &gt; 40%</strong> ‚Üí Risiko boncos tinggi. Hanya pakai buat <em>grand opening</em> atau flash sale 1‚Äì2 hari saja.</li>
        <li>üí° Trik: <strong>Naikkan harga normal dulu 10‚Äì15%</strong> sebelum bikin promo diskon, biar margin tetap aman.</li>
        <li>üõµ Kalau promo lewat GoFood/Shopee, pastikan harga promo di app sudah dikurangi platform fee. Jangan sampai harga promonya malah lebih kecil dari HPP!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üì¶ Tips Promo Bundling</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Bundling beda kategori</strong> jauh lebih menarik daripada bundling item sama. Contoh: Takoyaki + Dimsum = "Paket Jajan Duo" lebih menggoda dari 2x Takoyaki.</li>
        <li>Tujuan bundling bukan cuma diskon ‚Äî tapi juga <strong>naikin nilai transaksi per pelanggan</strong>. Kalau biasanya orang beli 1 item, dengan bundling bisa beli 2‚Äì3 item sekaligus.</li>
        <li>Harga bundling ideal: <strong>hemat 10‚Äì20%</strong> dibanding beli satuan. Lebih dari itu, cek margin dulu!</li>
        <li>üí° Nama paket yang kreatif bikin bundling lebih laku. Contoh: <em>"Paket Mantap Pisan"</em>, <em>"Combo Heula"</em>, <em>"Box Jajan Bareng"</em>.</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üéÅ Tips Promo Beli X Gratis Y</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li><strong>Beli 2 Gratis 1</strong> = diskon efektif 33%. Ini promo paling populer dan mudah dipahami pelanggan.</li>
        <li><strong>Beli 3 Gratis 1</strong> = diskon efektif 25%, lebih aman di margin tapi tetap terasa "wow" buat pelanggan.</li>
        <li>Item yang digratiskan sebaiknya <strong>item dengan HPP paling rendah</strong> dalam daftar menu kamu, biar ruginya minimal.</li>
        <li>Promo ini sangat efektif buat <strong>mendorong repeat order</strong>. Pelanggan cenderung balik lagi karena merasa dapat nilai lebih.</li>
        <li>üí° Batasi promo ini pada jam sepi (misal: weekday siang) supaya margin harian tetap terjaga saat jam ramai.</li>
        <li>‚ö†Ô∏è Jangan jalankan promo ini tanpa hitung estimasi transaksi harian dulu. Kalau ramai, kerugian per transaksi bisa numpuk cepat!</li>
      </ul>
    </div>

    <div class="card">
      <div class="card-title" style="margin-bottom:14px;">üìÖ Kapan Waktu Terbaik Promo?</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div style="background:#FFF3CD;border-radius:12px;padding:14px;border:2px solid #FFD54F;">
          <div style="font-size:13px;font-weight:900;color:#856404;margin-bottom:8px;">üöÄ Grand Opening</div>
          <div style="font-size:12px;font-weight:700;color:#7B5800;line-height:1.8;">Diskon besar (30‚Äì40%) boleh, tapi batasi 3‚Äì7 hari saja. Tujuannya bikin orang penasaran dan nyobain.</div>
        </div>
        <div style="background:#D4EDDA;border-radius:12px;padding:14px;border:2px solid #86EFAC;">
          <div style="font-size:13px;font-weight:900;color:#155724;margin-bottom:8px;">üìÜ Promo Rutin</div>
          <div style="font-size:12px;font-weight:700;color:#1a6b30;line-height:1.8;">Diskon 10‚Äì20% atau bundling ringan. Jadwal tetap (misal: Senin‚ÄìRabu) biar pelanggan hafal dan balik lagi.</div>
        </div>
        <div style="background:#FFE0D0;border-radius:12px;padding:14px;border:2px solid #FFAB91;">
          <div style="font-size:13px;font-weight:900;color:#B94A00;margin-bottom:8px;">‚ö° Flash Sale</div>
          <div style="font-size:12px;font-weight:700;color:#8B3A00;line-height:1.8;">Diskon besar tapi durasi pendek (2‚Äì4 jam). Efektif buat ngabisin stok atau nge-boost order di jam sepi.</div>
        </div>
        <div style="background:#E0E0FF;border-radius:12px;padding:14px;border:2px solid #B0B0FF;">
          <div style="font-size:13px;font-weight:900;color:#3030B0;margin-bottom:8px;">üéâ Momen Spesial</div>
          <div style="font-size:12px;font-weight:700;color:#252580;line-height:1.8;">Harbolnas, ulang tahun toko, Lebaran, dll. Kombinasi bundling + diskon ringan untuk maksimal dampak.</div>
        </div>
      </div>
    </div>

    <div class="card" style="background:linear-gradient(135deg,#FFF8F0,#FFF0E0);border-color:var(--orange);">
      <div class="card-title" style="margin-bottom:10px;color:var(--red);">‚ö†Ô∏è Kesalahan Promo yang Sering Terjadi</div>
      <ul style="font-size:14px;line-height:2.1;color:#444;font-weight:600;padding-left:20px;">
        <li>‚ùå <strong>Promo tanpa hitung HPP dulu</strong> ‚Üí Ujung-ujungnya boncos tanpa sadar.</li>
        <li>‚ùå <strong>Promo terlalu lama</strong> ‚Üí Pelanggan jadi gak mau beli di harga normal.</li>
        <li>‚ùå <strong>Lupa hitung platform fee</strong> ‚Üí Harga promo di GoFood/Shopee masih harus cover potongan 20‚Äì30%.</li>
        <li>‚ùå <strong>Promo semua menu sekaligus</strong> ‚Üí Lebih baik promo 1‚Äì2 menu andalan saja, biar ada yang beli menu lain juga.</li>
        <li>‚úÖ <strong>Yang bener:</strong> Hitung di kalkulator dulu ‚Üí tentukan durasi ‚Üí evaluasi setelah promo selesai!</li>
      </ul>
    </div>

  </div>

</div>

<!-- MODAL DETAIL BAHAN -->
<div class="modal-overlay" id="modal-detail" onclick="if(event.target===this)tutupDetail()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üîç Detail Bahan Baku</div>
      <button class="modal-close" onclick="tutupDetail()">‚úï</button>
    </div>
    <div class="modal-body" id="modal-detail-body"></div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupDetail()">Tutup</button>
      <button class="btn btn-primary" onclick="exportDetailPDF()" style="background:linear-gradient(135deg,#E03027,#F47C20);">
        üìÑ Export PDF
      </button>
    </div>
  </div>
</div>

<!-- MODAL EDIT MENU -->
<div class="modal-overlay" id="modal-edit" onclick="if(event.target===this)tutupEdit()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Menu</div>
      <button class="modal-close" onclick="tutupEdit()">‚úï</button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-idx" />

      <div class="form-row" style="margin-bottom:12px;">
        <div class="form-group">
          <label>Nama Menu</label>
          <input type="text" id="edit-nama" />
        </div>
        <div class="form-group">
          <label>Kategori</label>
          <select id="edit-kategori">
            <option value="takoyaki">üêô Takoyaki</option>
            <option value="dimsum">ü•ü Dimsum</option>
            <option value="ayam">üçó Ayam Crispy</option>
            <option value="lainnya">üç± Lainnya</option>
          </select>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:16px;">
        <label>Foto Menu</label>
        <input type="file" id="edit-foto-menu" accept="image/*" onchange="previewFoto(this, 'preview-edit-foto')" style="width:100%;padding:8px 10px;border-radius:8px;border:2px solid var(--border);font-size:13px;" />
        <div id="preview-edit-foto" style="margin-top:8px;"></div>
      </div>

      <div class="form-row" style="margin-bottom:16px;">
        <div class="form-group">
          <label>Porsi / Batch (pcs)</label>
          <input type="number" id="edit-porsi" min="1" oninput="hitungEditHPP()" />
        </div>
        <div class="form-group">
          <label>Biaya Kemasan / pcs (Rp)</label>
          <input type="number" id="edit-kemasan" min="0" oninput="hitungEditHPP()" />
        </div>
      </div>

      <!-- BAHAN BAKU -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">üßÖ Bahan Baku</div>
        </div>
        <div class="bahan-header">
          <span>Nama Bahan</span>
          <span>Qty Pakai</span>
          <span class="col-harga-satuan">Harga Beli (Rp)</span>
          <span class="col-harga-satuan">Ukuran Beli</span>
          <span></span>
        </div>
        <div id="edit-bahan-list"></div>
        <button class="btn btn-add" onclick="tambahEditBahan()">Ôºã Tambah Bahan</button>
      </div>

      <!-- BIAYA OPERASIONAL -->
      <div class="card" style="margin-bottom:12px;">
        <div class="card-header">
          <div class="card-title">‚öôÔ∏è Biaya Operasional / Batch</div>
        </div>
        <div id="edit-biaya-list"></div>
        <button class="btn btn-add" onclick="tambahEditBiaya()">Ôºã Tambah Biaya</button>
      </div>

      <!-- HARGA JUAL -->
      <div class="form-group" style="margin-bottom:8px;">
        <label>Harga Jual (Rp) ‚Äî bisa disesuaikan manual</label>
        <input type="number" id="edit-harga-jual" min="0" />
      </div>

      <!-- HPP PREVIEW -->
      <div class="edit-hpp-preview" id="edit-hpp-preview">‚Äî</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="tutupEdit()">Batal</button>
      <button class="btn btn-primary" onclick="simpanEdit()">üíæ Simpan Perubahan</button>
    </div>
  </div>
</div>

<!-- PRINT AREA -->
<div id="print-area"></div>

<!-- TOAST -->
<div class="toast" id="toast">‚úÖ Tersimpan!</div>

<script>
// =====================
// STATE
// =====================
let bahanCount = 0;
let biayaCount = 0;
let menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
let lastHPP = 0;
let lastPorsi = 0;
let lastNama = '';

// =====================
// INIT
// =====================
window.onload = () => {
  tambahBahan(); tambahBahan(); tambahBahan();
  tambahBiaya();
  renderRingkasan();
  tambahBundleItem();
  tambahBundleItem();
};

// =====================
// TAB
// =====================
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-icon').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + id).classList.add('active');
  event.currentTarget.classList.add('active');
  if (id === 'ringkasan') { renderRingkasan(); updateSyncStatus(); }
  if (id === 'laporan') initLaporan();
  if (id === 'promo') { 
    refreshDropdownDiskon(); 
    refreshAllBundleDropdowns();
    refreshDropdownBeliGratis();
  }
}


// =====================
// BAHAN
// =====================
function tambahBahan() {
  bahanCount++;
  const id = bahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'bahan-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Tepung takoyaki" />
    <input type="number" min="0" step="any" placeholder="150" title="Qty yang dipakai per batch" />
    <input type="number" min="0" step="any" placeholder="12000" title="Harga beli total (Rp)" class="col-harga-satuan" />
    <input type="number" min="0" step="any" placeholder="1000" title="Ukuran/berat kemasan beli" class="col-harga-satuan" />
    <button class="btn btn-danger" onclick="hapusBahan(${id})" title="Hapus">‚úï</button>
  `;
  document.getElementById('bahan-list').appendChild(div);
}

function hapusBahan(id) {
  const el = document.getElementById('bahan-' + id);
  if (el) el.remove();
}

// =====================
// BIAYA OPERASIONAL
// =====================
function tambahBiaya() {
  biayaCount++;
  const id = biayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'biaya-' + id;
  div.innerHTML = `
    <input type="text" placeholder="cth: Gas LPG per batch" />
    <input type="number" min="0" step="any" placeholder="1000" title="Biaya (Rp)" />
    <button class="btn btn-danger" onclick="hapusBiaya(${id})" title="Hapus">‚úï</button>
  `;
  document.getElementById('biaya-list').appendChild(div);
}

function hapusBiaya(id) {
  const el = document.getElementById('biaya-' + id);
  if (el) el.remove();
}

// =====================
// HITUNG HPP
// =====================
let lastSnapshot = {}; // simpan raw data bahan untuk disimpan ke ringkasan

function hitungHPP() {
  const nama = document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = document.getElementById('kategori-menu').value;
  const porsi = parseFloat(document.getElementById('porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('biaya-kemasan').value) || 0;

  // Hitung bahan ‚Äî scope ke #bahan-list supaya tidak baca dari modal edit
  let totalBahan = 0;
  const bahanRows = document.querySelectorAll('#bahan-list .bahan-row');
  const bahanDetail = [];
  const bahanRaw = [];

  bahanRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaBahan = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!namaBahan || qty === 0 || hargaBeli === 0) return;

    const biayaBahan = (qty / ukuranBeli) * hargaBeli;
    totalBahan += biayaBahan;
    bahanDetail.push({ nama: namaBahan, biaya: biayaBahan });
    bahanRaw.push({ nama: namaBahan, qty, hargaBeli, ukuranBeli, biaya: biayaBahan });
  });

  // Hitung biaya operasional ‚Äî scope ke #biaya-list supaya tidak baca dari modal edit
  let totalOperasional = 0;
  const biayaRows = document.querySelectorAll('#biaya-list .biaya-row');
  const biayaDetail = [];
  const biayaRaw = [];

  biayaRows.forEach(row => {
    const inputs = row.querySelectorAll('input');
    const namaB = inputs[0].value.trim();
    const nominal = parseFloat(inputs[1].value) || 0;
    if (!namaB || nominal === 0) return;
    totalOperasional += nominal;
    biayaDetail.push({ nama: namaB, biaya: nominal });
    biayaRaw.push({ nama: namaB, biaya: nominal });
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalOperasional);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  lastHPP = hpp;
  lastPorsi = porsi;
  lastNama = nama;

  // Simpan snapshot lengkap untuk disimpan ke ringkasan
  lastSnapshot = { nama, kategori, porsi, kemasan, bahanRaw, biayaRaw, totalBatch, hpp, foto: currentFotoBase64 };

  // Update UI
  document.getElementById('res-total-batch').textContent = formatRp(totalBatch);
  document.getElementById('res-batch-info').textContent = `untuk ${porsi} pcs / batch`;
  document.getElementById('res-hpp').textContent = formatRp(hpp);
  document.getElementById('res-bep').textContent = formatRp(bep);

  // Saran harga jual - offline & online
  const harga30 = roundHargaMakanan(hpp / (1 - 0.30));
  const harga50 = roundHargaMakanan(hpp / (1 - 0.50));
  const harga70 = roundHargaMakanan(hpp / (1 - 0.70));

  // Offline (harga normal)
  document.getElementById('harga-30-offline').textContent = formatRp(harga30);
  document.getElementById('harga-50-offline').textContent = formatRp(harga50);
  document.getElementById('harga-70-offline').textContent = formatRp(harga70);

  // Online (markup 25% untuk cover fee 20%)
  document.getElementById('harga-30-online').textContent = formatRp(roundHargaMakanan(harga30 * 1.25));
  document.getElementById('harga-50-online').textContent = formatRp(roundHargaMakanan(harga50 * 1.25));
  document.getElementById('harga-70-online').textContent = formatRp(roundHargaMakanan(harga70 * 1.25));

  // Breakdown table
  const tbody = document.getElementById('breakdown-body');
  tbody.innerHTML = '';

  const addRow = (nama, keterangan, biaya) => {
    const pct = totalBatch > 0 ? ((biaya / totalBatch) * 100).toFixed(1) : '0.0';
    tbody.innerHTML += `
      <tr>
        <td>${nama}</td>
        <td style="color:var(--muted);font-size:12px;">${keterangan}</td>
        <td class="text-right">${formatRp(biaya)}</td>
        <td class="text-right" style="color:var(--muted);">${pct}%</td>
      </tr>
    `;
  };

  bahanDetail.forEach(b => addRow(b.nama, 'Bahan baku', b.biaya));
  if (totalKemasan > 0) addRow('Kemasan', `${formatRp(kemasan)} √ó ${porsi} pcs`, totalKemasan);
  biayaDetail.forEach(b => addRow(b.nama, 'Biaya operasional', b.biaya));

  tbody.innerHTML += `
    <tr class="total-row">
      <td colspan="2"><strong>TOTAL BIAYA BATCH</strong></td>
      <td class="text-right"><strong>${formatRp(totalBatch)}</strong></td>
      <td class="text-right"><strong>100%</strong></td>
    </tr>
    <tr class="total-row">
      <td colspan="2"><strong>HPP PER PCS</strong></td>
      <td class="text-right"><strong>${formatRp(hpp)}</strong></td>
      <td></td>
    </tr>
  `;

  document.getElementById('hasil-section').style.display = 'block';
  document.getElementById('hasil-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// =====================
// SIMPAN
// =====================
function simpanMenu() {
  const nama = lastSnapshot.nama || document.getElementById('nama-menu').value.trim() || 'Menu Tanpa Nama';
  const kategori = lastSnapshot.kategori || document.getElementById('kategori-menu').value;
  const hpp = lastHPP;
  const hargaJual = roundHargaMakanan(hpp / (1 - 0.50));

  const obj = {
    nama, kategori,
    porsi: lastSnapshot.porsi,
    kemasan: lastSnapshot.kemasan,
    hpp, hargaJual, margin: 50,
    tanggal: getWIBDateTimeString(), // WIB timezone
    totalBatch: lastSnapshot.totalBatch,
    bahanRaw: lastSnapshot.bahanRaw || [],
    biayaRaw: lastSnapshot.biayaRaw || [],
    foto: lastSnapshot.foto || null, // Simpan foto base64
  };

  const existing = menuList.findIndex(m => m.nama === nama);
  if (existing >= 0) menuList[existing] = obj;
  else menuList.push(obj);

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  showToast(`‚úÖ "${nama}" tersimpan!`);

  setTimeout(() => {
    if (confirm(`"${nama}" berhasil disimpan! üéâ\n\nMau langsung input menu baru? Klik OK untuk reset form, atau Batal untuk tetap di halaman ini.`)) {
      resetForm();
      lastSnapshot = {};
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }, 300);
}

function renderRingkasan() {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const container = document.getElementById('ringkasan-list');

  if (menuList.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="es-icon">üç±</div>
        <p>Belum ada menu tersimpan</p>
        <small>Hitung HPP dulu di tab "Hitung HPP", lalu klik "Simpan ke Ringkasan Menu"</small>
      </div>`;
    return;
  }

  let html = '';

  const totalMenu = menuList.length;
  const rataHPP = menuList.reduce((s, m) => s + m.hpp, 0) / totalMenu;
  html += `
    <div class="result-box" style="margin-bottom:20px;">
      <h3>üìä Statistik Menu</h3>
      <div class="result-grid">
        <div class="result-item">
          <span class="label">Total Menu</span>
          <div class="value">${totalMenu}</div>
          <div class="sub">menu terdaftar</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata HPP</span>
          <div class="value">${formatRp(rataHPP)}</div>
          <div class="sub">per pcs</div>
        </div>
        <div class="result-item">
          <span class="label">Rata-rata Harga Jual</span>
          <div class="value">${formatRp(menuList.reduce((s, m) => s + m.hargaJual, 0) / totalMenu)}</div>
          <div class="sub">margin 50%</div>
        </div>
      </div>
    </div>
  `;

  menuList.forEach((m, i) => {
    const hj = m.hargaJual;
    const profit = hj - m.hpp;
    const hasBahan = m.bahanRaw && m.bahanRaw.length > 0;
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep  = Math.round(m.hpp / (1 - 0.30));
    html += `
      <div class="menu-card" style="cursor:default;flex-direction:column;align-items:stretch;gap:14px;">
        <!-- Baris atas: foto + info + angka -->
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:14px;flex-wrap:wrap;">
          ${m.foto ? `
            <div style="flex-shrink:0;">
              <img src="${m.foto}" style="width:80px;height:80px;object-fit:cover;border-radius:12px;border:2px solid var(--border);" />
            </div>
          ` : ''}
          <div class="mc-left" style="flex:1;min-width:200px;">
            <div class="mc-name">${m.nama}</div>
            <div style="margin-top:4px;">
              <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
              <span style="font-size:11px;color:var(--muted);font-weight:700;">${m.tanggal}</span>
              ${hasBahan ? `<span style="font-size:10px;background:#E8F5E9;color:#2E7D32;font-weight:800;padding:2px 8px;border-radius:10px;margin-left:4px;">üìã Ada ${m.bahanRaw.length} bahan</span>` : ''}
            </div>
          </div>
          <div class="mc-right">
            <div class="mc-hpp">HPP: ${formatRp(m.hpp)}/pcs</div>
            <div class="mc-price">${formatRp(hj)}</div>
            <div class="mc-margin">+${formatRp(profit)} profit/pcs</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px;">${m.porsi} pcs/batch</div>
          </div>
        </div>

        <!-- Rekomendasi harga -->
        <div style="background:var(--bg);border-radius:12px;padding:12px;">
          <div style="font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;">üí° Rekomendasi Harga</div>
          
          <!-- Header kolom -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:6px;font-size:9px;font-weight:700;color:#666;">
            <div></div>
            <div style="text-align:center;">üè™ OFFLINE</div>
            <div style="text-align:center;">üì± ONLINE</div>
          </div>

          <!-- Ekonomis -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üü° 30%</div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h30)}</div>
            </div>
            <div style="background:#FFF9E6;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h30*1.25))}</div>
            </div>
          </div>

          <!-- Standar -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;margin-bottom:4px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üü¢ 50%</div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===h50?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h50)}</div>
            </div>
            <div style="background:#E8F5E9;border:2px solid ${Math.round(hj)===roundHargaMakanan(h50*1.25)?'#27AE60':'#C8E6C9'};border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h50*1.25))}</div>
            </div>
          </div>

          <!-- Premium -->
          <div style="display:grid;grid-template-columns:80px 1fr 1fr;gap:6px;">
            <div style="font-size:8px;font-weight:700;color:#999;display:flex;align-items:center;">üî• 70%</div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(h70)}</div>
            </div>
            <div style="background:#FFF0EF;border:1px solid #F0E0CC;border-radius:6px;padding:6px;text-align:center;">
              <div style="font-family:'Fredoka One',cursive;font-size:12px;color:var(--dark);">${formatRp(roundHargaMakanan(h70*1.25))}</div>
            </div>
          </div>
        </div>

        <!-- Tombol aksi -->
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="lihatDetail(${i})">üîç Detail Bahan</button>
          <button class="btn btn-secondary" style="font-size:11px;padding:6px 12px;" onclick="editMenu(${i})">‚úèÔ∏è Edit</button>
          <button class="btn btn-danger" style="font-size:11px;padding:6px 12px;" onclick="hapusItem(${i})">üóëÔ∏è</button>
        </div>
      </div>
    `;
  });

  html += `
    <div style="text-align:right;margin-top:8px;">
      <button class="btn btn-secondary" onclick="hapusSemua()">üóëÔ∏è Hapus Semua</button>
    </div>
  `;

  container.innerHTML = html;
}

function hapusSemua() {
  if (confirm('Yakin mau hapus semua data menu?')) {
    menuList = [];
    localStorage.removeItem('kedaiHeula_menu');
    renderRingkasan();
  }
}

function hapusItem(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  if (!menuList[i]) return;
  if (confirm(`Hapus "${menuList[i].nama}"?`)) {
    menuList.splice(i, 1);
    localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
    renderRingkasan();
    showToast('üóëÔ∏è Menu dihapus');
  }
}

// =====================
// DETAIL BAHAN MODAL
// =====================
function lihatDetail(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  const totalBahan = (m.bahanRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = (m.biayaRaw || []).reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = (m.kemasan || 0) * (m.porsi || 1);

  let bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="text-right">${b.qty}</td>
      <td class="text-right">${b.ukuranBeli}</td>
      <td class="text-right">${formatRp(b.hargaBeli)}</td>
      <td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td>
    </tr>`).join('');

  if (!bahanRows) bahanRows = `<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:16px;">Tidak ada data bahan tersimpan</td></tr>`;

  let biayaRows = (m.biayaRaw || []).map(b => `
    <tr><td>${b.nama}</td><td colspan="3"></td><td class="text-right" style="font-weight:800;">${formatRp(b.biaya)}</td></tr>
  `).join('');

  document.getElementById('modal-detail-body').innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:12px;margin-bottom:20px;">
      <div>
        <div style="font-family:'Fredoka One',cursive;font-size:22px;color:var(--red);">${m.nama}</div>
        <div style="margin-top:4px;">
          <span class="tag tag-${m.kategori}">${getCategoryLabel(m.kategori)}</span>
          <span style="font-size:12px;color:var(--muted);font-weight:700;margin-left:6px;">Tersimpan ${m.tanggal}</span>
        </div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:12px;color:var(--muted);font-weight:700;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:26px;color:var(--red);">${formatRp(m.hpp)}</div>
        <div style="font-size:11px;color:var(--muted);">Batch: ${m.porsi} pcs ¬∑ Kemasan: ${formatRp(m.kemasan)}/pcs</div>
      </div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">üßÖ Bahan Baku</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Nama Bahan</th>
            <th class="text-right">Qty Pakai</th>
            <th class="text-right">Ukuran Beli</th>
            <th class="text-right">Harga Beli</th>
            <th class="text-right">Biaya</th>
          </tr>
        </thead>
        <tbody>
          ${bahanRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Bahan</strong></td>
            <td class="text-right"><strong>${formatRp(totalBahan)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>

    ${m.biayaRaw && m.biayaRaw.length > 0 ? `
    <div class="card" style="margin-bottom:12px;">
      <div class="card-title" style="margin-bottom:12px;">‚öôÔ∏è Biaya Operasional</div>
      <table class="breakdown-table">
        <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="text-right">Biaya</th></tr></thead>
        <tbody>
          ${biayaRows}
          <tr class="total-row">
            <td colspan="4"><strong>Total Operasional</strong></td>
            <td class="text-right"><strong>${formatRp(totalBiaya)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>` : ''}

    <div style="background:linear-gradient(135deg,var(--red),var(--orange));border-radius:14px;padding:16px;color:white;display:grid;grid-template-columns:repeat(3,1fr);gap:10px;text-align:center;">
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Total Biaya Batch</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.totalBatch || (totalBahan + totalBiaya + totalKemasan))}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">HPP / pcs</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hpp)}</div>
      </div>
      <div>
        <div style="font-size:10px;opacity:0.8;font-weight:800;text-transform:uppercase;">Harga Jual</div>
        <div style="font-family:'Fredoka One',cursive;font-size:18px;">${formatRp(m.hargaJual)}</div>
      </div>
    </div>
  `;

  document.getElementById('modal-detail').style.display = 'flex';
  // Simpan index ke modal supaya bisa dipakai tombol export
  document.getElementById('modal-detail').dataset.menuIdx = i;
}

function tutupDetail() {
  document.getElementById('modal-detail').style.display = 'none';
}

function exportDetailPDF() {
  try {
    const i = parseInt(document.getElementById('modal-detail').dataset.menuIdx);
    menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
    const m = menuList[i];
    if (!m) {
      showToast('‚ùå Menu tidak ditemukan');
      return;
    }

    const totalBahan   = (m.bahanRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalBiaya   = (m.biayaRaw  || []).reduce((s, b) => s + (b.biaya || 0), 0);
    const totalKemasan = (m.kemasan   || 0) * (m.porsi || 1);
    const totalBatch   = m.totalBatch || (totalBahan + totalBiaya + totalKemasan);
    const h30 = roundHargaMakanan(m.hpp / (1 - 0.30));
    const h50 = roundHargaMakanan(m.hpp / (1 - 0.50));
    const h70 = roundHargaMakanan(m.hpp / (1 - 0.70));
    const bep = Math.round(m.hpp / (1 - 0.30));

  const bahanRows = (m.bahanRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td class="pr-num">${b.qty}</td>
      <td class="pr-num">${b.ukuranBeli}</td>
      <td class="pr-num">${formatRp(b.hargaBeli)}</td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('') || `<tr><td colspan="5" style="text-align:center;color:#999;padding:12px;">Tidak ada data bahan</td></tr>`;

  const kemasanRow = m.kemasan > 0 ? `
    <tr>
      <td>Kemasan</td>
      <td colspan="3" style="color:#888;font-size:11px;">${formatRp(m.kemasan)} √ó ${m.porsi} pcs</td>
      <td class="pr-num"><strong>${formatRp(totalKemasan)}</strong></td>
    </tr>` : '';

  const biayaRows = (m.biayaRaw || []).map(b => `
    <tr>
      <td>${b.nama}</td>
      <td colspan="3"></td>
      <td class="pr-num"><strong>${formatRp(b.biaya)}</strong></td>
    </tr>`).join('');

  const biayaSection = (m.biayaRaw && m.biayaRaw.length > 0) ? `
    <h3>‚öôÔ∏è Biaya Operasional per Batch</h3>
    <table>
      <thead><tr><th>Keterangan</th><th colspan="3"></th><th class="pr-num">Biaya</th></tr></thead>
      <tbody>
        ${biayaRows}
        <tr class="total-row">
          <td colspan="4"><strong>Total Operasional</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBiaya)}</strong></td>
        </tr>
      </tbody>
    </table>` : '';

  const tanggalCetak = new Date().toLocaleDateString('id-ID', { day:'numeric', month:'long', year:'numeric' });

  const printContent = `
    <div class="doc-header">
      <div>
        <div class="brand">üç± Kedai Heula</div>
        <div class="brand-sub">Kalkulator HPP ‚Äì Referensi Bahan Baku</div>
      </div>
      <div class="doc-meta">
        <div class="menu-name">${m.nama}</div>
        <div class="meta-sub">${getCategoryLabel(m.kategori)} ¬∑ Tersimpan ${m.tanggal} ¬∑ ${m.porsi} pcs/batch</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">Total Biaya Batch</span>
        <span class="sum-value">${formatRp(totalBatch)}</span>
        <span class="sum-sub">${m.porsi} pcs</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">HPP / pcs</span>
        <span class="sum-value">${formatRp(m.hpp)}</span>
        <span class="sum-sub">harga pokok</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Min. BEP</span>
        <span class="sum-value">${formatRp(bep)}</span>
        <span class="sum-sub">incl. platform fee</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">Harga Jual</span>
        <span class="sum-value">${formatRp(m.hargaJual)}</span>
        <span class="sum-sub">tersimpan</span>
      </div>
    </div>

    <h3>üßÖ Bahan Baku</h3>
    <table>
      <thead>
        <tr>
          <th>Nama Bahan</th>
          <th class="pr-num">Qty Pakai</th>
          <th class="pr-num">Ukuran Beli</th>
          <th class="pr-num">Harga Beli</th>
          <th class="pr-num">Biaya</th>
        </tr>
      </thead>
      <tbody>
        ${bahanRows}
        ${kemasanRow}
        <tr class="total-row">
          <td colspan="4"><strong>Total Bahan + Kemasan</strong></td>
          <td class="pr-num"><strong>${formatRp(totalBahan + totalKemasan)}</strong></td>
        </tr>
      </tbody>
    </table>

    ${biayaSection}

    <div class="harga-section">
      <div class="harga-title">‚úÖ Rekomendasi Harga Jual</div>
      <div class="harga-grid">
        <div class="harga-box ekonomis">
          <span class="hb-label">üü° Ekonomis</span>
          <span class="hb-value">${formatRp(h30)}</span>
          <span class="hb-margin">Margin 30%</span>
        </div>
        <div class="harga-box standar">
          <span class="hb-label">üü¢ Standar</span>
          <span class="hb-value">${formatRp(h50)}</span>
          <span class="hb-margin">Margin 50%</span>
        </div>
        <div class="harga-box premium">
          <span class="hb-label">üî• Premium</span>
          <span class="hb-value">${formatRp(h70)}</span>
          <span class="hb-margin">Margin 70%</span>
        </div>
      </div>
    </div>

    <div class="doc-footer">
      <span>Kedai Heula ‚Äì Manajemen Bisnis Kuliner</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('‚ùå Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  // Deteksi platform
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    // Telegram Mobile: kasih tau fitur tidak tersedia
    showToast('‚ÑπÔ∏è Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    // Desktop atau mobile browser biasa: print
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportDetailPDF:', error);
    showToast('‚ùå Error: ' + error.message);
  }
}

// =====================
// EDIT MENU MODAL
// =====================
function editMenu(i) {
  menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[i];
  if (!m) return;

  console.log('üìù Edit menu:', m.nama);
  console.log('üßÖ bahanRaw:', m.bahanRaw);
  console.log('‚öôÔ∏è biayaRaw:', m.biayaRaw);

  document.getElementById('edit-idx').value = i;
  document.getElementById('edit-nama').value = m.nama;
  document.getElementById('edit-kategori').value = m.kategori;
  document.getElementById('edit-porsi').value = m.porsi;
  document.getElementById('edit-kemasan').value = m.kemasan || 0;
  document.getElementById('edit-harga-jual').value = Math.round(m.hargaJual);

  // Load foto jika ada
  const previewEdit = document.getElementById('preview-edit-foto');
  if (m.foto) {
    currentFotoBase64 = m.foto; // Set foto saat ini
    previewEdit.innerHTML = `
      <div style="position:relative;display:inline-block;">
        <img src="${m.foto}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
        <button onclick="hapusFoto('preview-edit-foto', 'edit-foto-menu')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">√ó</button>
      </div>
    `;
  } else {
    currentFotoBase64 = null;
    previewEdit.innerHTML = '';
    document.getElementById('edit-foto-menu').value = '';
  }

  // Render bahan
  const bahanContainer = document.getElementById('edit-bahan-list');
  bahanContainer.innerHTML = '';
  const bahanData = m.bahanRaw || [];
  console.log(`üîÑ Rendering ${bahanData.length} bahan...`);
  bahanData.forEach((b, j) => {
    console.log(`  - ${b.nama}: ${b.qty} @ Rp ${b.hargaBeli}`);
    bahanContainer.appendChild(buatEditBahanRow(j, b));
  });

  // Render biaya
  const biayaContainer = document.getElementById('edit-biaya-list');
  biayaContainer.innerHTML = '';
  const biayaData = m.biayaRaw || [];
  console.log(`üîÑ Rendering ${biayaData.length} biaya...`);
  biayaData.forEach((b, j) => {
    console.log(`  - ${b.nama}: Rp ${b.biaya}`);
    biayaContainer.appendChild(buatEditBiayaRow(j, b));
  });

  hitungEditHPP();
  document.getElementById('modal-edit').style.display = 'flex';
}

let editBahanCount = 0;
let editBiayaCount = 0;

function buatEditBahanRow(j, b) {
  editBahanCount++;
  const id = editBahanCount;
  const div = document.createElement('div');
  div.className = 'bahan-row';
  div.id = 'edit-bahan-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama bahan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.qty}" min="0" step="any" placeholder="Qty" oninput="hitungEditHPP()" />
    <input type="number" value="${b.hargaBeli}" min="0" step="any" placeholder="Harga beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <input type="number" value="${b.ukuranBeli}" min="0" step="any" placeholder="Ukuran beli" class="col-harga-satuan" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-bahan-${id}').remove(); hitungEditHPP();">‚úï</button>
  `;
  return div;
}

function buatEditBiayaRow(j, b) {
  editBiayaCount++;
  const id = editBiayaCount;
  const div = document.createElement('div');
  div.className = 'biaya-row';
  div.id = 'edit-biaya-' + id;
  div.innerHTML = `
    <input type="text" value="${b.nama}" placeholder="Nama biaya" oninput="hitungEditHPP()" />
    <input type="number" value="${b.biaya}" min="0" step="any" placeholder="Biaya (Rp)" oninput="hitungEditHPP()" />
    <button class="btn btn-danger" onclick="document.getElementById('edit-biaya-${id}').remove(); hitungEditHPP();">‚úï</button>
  `;
  return div;
}

function tambahEditBahan() {
  const container = document.getElementById('edit-bahan-list');
  container.appendChild(buatEditBahanRow(editBahanCount, { nama:'', qty:0, hargaBeli:0, ukuranBeli:1, biaya:0 }));
}

function tambahEditBiaya() {
  const container = document.getElementById('edit-biaya-list');
  container.appendChild(buatEditBiayaRow(editBiayaCount, { nama:'', biaya:0 }));
}

function hitungEditHPP() {
  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  let totalBahan = 0;
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    totalBahan += (qty / ukuranBeli) * hargaBeli;
  });

  let totalBiaya = 0;
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    totalBiaya += parseFloat(inputs[1].value) || 0;
  });

  const totalKemasan = kemasan * porsi;
  const totalBatch = Math.round(totalBahan + totalKemasan + totalBiaya);
  const hpp = Math.round(totalBatch / porsi);
  const bep = Math.round(hpp / (1 - 0.30));

  const h30 = roundHargaMakanan(hpp / (1 - 0.30));
  const h50 = roundHargaMakanan(hpp / (1 - 0.50));
  const h70 = roundHargaMakanan(hpp / (1 - 0.70));

  document.getElementById('edit-hpp-preview').innerHTML = hpp <= 0 ? '‚Äî' : `
    <div style="margin-bottom:10px;display:flex;justify-content:space-between;align-items:baseline;flex-wrap:wrap;gap:4px;">
      <span style="font-size:13px;font-weight:800;color:var(--dark);">
        HPP: <span style="color:var(--red);font-size:16px;">${formatRp(hpp)}/pcs</span>
      </span>
      <span style="font-size:11px;color:var(--muted);font-weight:700;">
        Total batch: ${formatRp(totalBatch)} &nbsp;¬∑&nbsp; Min. BEP: ${formatRp(bep)}
      </span>
    </div>
    <div style="font-size:11px;font-weight:800;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;">
      ‚úÖ Klik untuk pakai sebagai harga jual
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;">
      <div onclick="pakeHargaEdit(${Math.round(h30)})" style="background:linear-gradient(135deg,#FFF9E6,#FFF3CC);border:2px solid #F5C518;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#B8860B;">üü° EKONOMIS</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h30)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 30%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h50)})" style="background:linear-gradient(135deg,#E8F5E9,#C8E6C9);border:2px solid #27AE60;border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:#1B5E20;">üü¢ STANDAR</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h50)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 50%</div>
      </div>
      <div onclick="pakeHargaEdit(${Math.round(h70)})" style="background:linear-gradient(135deg,#FFF0EF,#FFD5D3);border:2px solid var(--red);border-radius:12px;padding:10px 8px;text-align:center;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-size:10px;font-weight:800;color:var(--red);">üî• PREMIUM</div>
        <div style="font-family:'Fredoka One',cursive;font-size:17px;color:var(--dark);margin:3px 0;">${formatRp(h70)}</div>
        <div style="font-size:10px;color:var(--muted);font-weight:700;">Margin 70%</div>
      </div>
    </div>
  `;
}

function pakeHargaEdit(harga) {
  document.getElementById('edit-harga-jual').value = harga;
  // Feedback visual singkat
  const input = document.getElementById('edit-harga-jual');
  input.style.borderColor = 'var(--green)';
  input.style.background = '#F0FDF4';
  setTimeout(() => { input.style.borderColor = ''; input.style.background = ''; }, 1200);
}

function simpanEdit() {
  const i = parseInt(document.getElementById('edit-idx').value);
  const m = menuList[i];
  if (!m) return;

  const porsi = parseFloat(document.getElementById('edit-porsi').value) || 1;
  const kemasan = parseFloat(document.getElementById('edit-kemasan').value) || 0;

  const bahanRaw = [];
  document.querySelectorAll('#edit-bahan-list .bahan-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const qty = parseFloat(inputs[1].value) || 0;
    const hargaBeli = parseFloat(inputs[2].value) || 0;
    const ukuranBeli = parseFloat(inputs[3].value) || 1;
    if (!nama || qty === 0) return;
    bahanRaw.push({ nama, qty, hargaBeli, ukuranBeli, biaya: (qty / ukuranBeli) * hargaBeli });
  });

  const biayaRaw = [];
  document.querySelectorAll('#edit-biaya-list .biaya-row').forEach(row => {
    const inputs = row.querySelectorAll('input');
    const nama = inputs[0].value.trim();
    const biaya = parseFloat(inputs[1].value) || 0;
    if (!nama || biaya === 0) return;
    biayaRaw.push({ nama, biaya });
  });

  const totalBahan = bahanRaw.reduce((s, b) => s + b.biaya, 0);
  const totalBiaya = biayaRaw.reduce((s, b) => s + b.biaya, 0);
  const totalKemasan = kemasan * porsi;
  const totalBatch = totalBahan + totalKemasan + totalBiaya;
  const hpp = totalBatch / porsi;
  const hargaJual = parseFloat(document.getElementById('edit-harga-jual').value) || hpp / (1 - 0.5);

  menuList[i] = {
    ...m,
    nama: document.getElementById('edit-nama').value.trim() || m.nama,
    kategori: document.getElementById('edit-kategori').value,
    porsi, kemasan, bahanRaw, biayaRaw,
    totalBatch, hpp, hargaJual,
    tanggal: getWIBDateTimeString(), // WIB timezone
    foto: currentFotoBase64, // Update foto (bisa null jika dihapus)
  };

  localStorage.setItem('kedaiHeula_menu', JSON.stringify(menuList));
  tutupEdit();
  renderRingkasan();
  showToast(`‚úÖ "${menuList[i].nama}" diperbarui!`);
}

function tutupEdit() {
  document.getElementById('modal-edit').style.display = 'none';
}

// =====================
// GENERATE POSTER INSTAGRAM
// =====================
function updatePosterPreview() {
  const canvas = document.getElementById('poster-canvas');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  const w = 1080;
  const h = 1080;
  
  const type = document.getElementById('poster-type')?.value || 'diskon';
  const title = document.getElementById('poster-title')?.value || 'PROMO SPESIAL!';
  const detail = document.getElementById('poster-detail')?.value || 'Periode terbatas';
  
  // Background gradient orange
  const gradient = ctx.createLinearGradient(0, 0, 0, h);
  gradient.addColorStop(0, '#FF8C42');
  gradient.addColorStop(0.5, '#F47C20');
  gradient.addColorStop(1, '#E03027');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, w, h);
  
  // White card
  ctx.fillStyle = '#FFFAF5';
  ctx.beginPath();
  ctx.roundRect(80, 200, 920, 680, 40);
  ctx.fill();
  
  // Title
  ctx.fillStyle = '#E03027';
  ctx.font = 'bold 72px Arial';
  ctx.textAlign = 'center';
  ctx.fillText(title.toUpperCase(), w/2, 400);
  
  // Detail
  ctx.fillStyle = '#1A1A1A';
  ctx.font = '500 42px Arial';
  const lines = detail.split('\n');
  let y = 520;
  lines.forEach(line => {
    ctx.fillText(line, w/2, y);
    y += 60;
  });
  
  // Footer
  ctx.fillStyle = 'white';
  ctx.font = 'bold 36px Arial';
  ctx.fillText('Kedai Heula - Jajanan Mantap Pisan!', w/2, h - 100);
  
  // Logo circle
  ctx.fillStyle = 'white';
  ctx.beginPath();
  ctx.arc(w/2, 120, 80, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = '#F47C20';
  ctx.font = 'bold 64px Arial';
  ctx.fillText('üç±', w/2, 145);
}

function downloadPoster() {
  const canvas = document.getElementById('poster-canvas');
  if (!canvas) return;
  
  const link = document.createElement('a');
  link.download = `kedai-heula-poster-${Date.now()}.png`;
  link.href = canvas.toDataURL('image/png');
  link.click();
  showToast('‚úÖ Poster berhasil didownload!');
}

// =====================
// HELPERS
// =====================
// =====================
// HELPER FUNCTIONS
// =====================

let currentFotoBase64 = null; // Store foto saat ini

// Deteksi apakah di mobile/Telegram
function isMobileOrTelegram() {
  const ua = navigator.userAgent.toLowerCase();
  return /mobile|android|iphone|ipad|telegram/i.test(ua) || window.innerWidth < 768;
}

// Preview foto yang diupload
function previewFoto(input, previewId) {
  const preview = document.getElementById(previewId);
  
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    // Validasi ukuran (max 2MB)
    if (file.size > 2 * 1024 * 1024) {
      alert('Ukuran foto terlalu besar! Maksimal 2MB.');
      input.value = '';
      preview.innerHTML = '';
      currentFotoBase64 = null;
      return;
    }
    
    const reader = new FileReader();
    
    reader.onload = function(e) {
      const original = e.target.result;
      
      // Tampilkan preview dulu (pakai original)
      preview.innerHTML = `
        <div style="position:relative;display:inline-block;">
          <img src="${original}" style="max-width:200px;max-height:200px;border-radius:12px;border:2px solid var(--border);" />
          <button onclick="hapusFoto('${previewId}', '${input.id}')" style="position:absolute;top:4px;right:4px;background:var(--red);color:white;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-weight:bold;font-size:12px;">√ó</button>
          <div style="font-size:10px;color:var(--muted);margin-top:4px;">‚è≥ Mengompres foto...</div>
        </div>
      `;
      
      // Kompres foto untuk sync (async)
      try {
        kompresGambar(original, 400, 400, 0.7, (compressed) => {
          currentFotoBase64 = compressed;
          // Update preview message
          const msg = preview.querySelector('div[style*="font-size:10px"]');
          if (msg) msg.textContent = '‚úì Siap untuk sync';
        });
      } catch (err) {
        console.error('Kompresi gagal, pakai original:', err);
        currentFotoBase64 = original; // Fallback ke original
      }
    };
    
    reader.readAsDataURL(file);
  } else {
    preview.innerHTML = '';
    currentFotoBase64 = null;
  }
}

// Kompres gambar untuk mengurangi ukuran base64
function kompresGambar(base64, maxWidth, maxHeight, quality, callback) {
  try {
    const img = new Image();
    
    img.onerror = function() {
      console.error('Gagal load image untuk kompresi');
      callback(base64); // Fallback ke original
    };
    
    img.onload = function() {
      try {
        const canvas = document.createElement('canvas');
        let width = img.width;
        let height = img.height;
        
        // Hitung resize ratio
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.round(width * ratio);
          height = Math.round(height * ratio);
        }
        
        canvas.width = width;
        canvas.height = height;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);
        
        // Convert ke base64 dengan kompresi
        const compressed = canvas.toDataURL('image/jpeg', quality);
        callback(compressed);
      } catch (err) {
        console.error('Gagal kompres canvas:', err);
        callback(base64); // Fallback ke original
      }
    };
    
    img.src = base64;
  } catch (err) {
    console.error('Error di kompresGambar:', err);
    callback(base64); // Fallback ke original
  }
}

// Hapus foto
function hapusFoto(previewId, inputId) {
  document.getElementById(previewId).innerHTML = '';
  document.getElementById(inputId).value = '';
  currentFotoBase64 = null;
}

// Get current date/time in WIB (UTC+7)
function getWIBDate() {
  const now = new Date();
  // Offset UTC ke WIB (+7 jam = +420 menit)
  const wibOffset = 7 * 60; // menit
  const localOffset = now.getTimezoneOffset(); // offset browser dalam menit (negatif untuk timezones di timur UTC)
  const wibTime = new Date(now.getTime() + (wibOffset + localOffset) * 60000);
  return wibTime;
}

// Format WIB date ke YYYY-MM-DD (untuk input type="date")
function getWIBDateString() {
  const wib = getWIBDate();
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
}

// Format WIB datetime untuk display (DD/MM/YYYY HH:MM)
function getWIBDateTimeString() {
  const wib = getWIBDate();
  return wib.toLocaleString('id-ID', { 
    timeZone: 'Asia/Jakarta',
    year: 'numeric',
    month: '2-digit', 
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Parse tanggal string YYYY-MM-DD dengan asumsi WIB
function parseWIBDate(dateStr) {
  // Parse sebagai midnight WIB, bukan UTC
  return new Date(dateStr + 'T00:00:00+07:00');
}

// Bulatkan harga makanan ke kelipatan yang lebih realistis
function roundHargaMakanan(harga) {
  const rounded = Math.round(harga);
  
  if (rounded < 1000) {
    // Di bawah 1000: bulatkan ke kelipatan 100
    return Math.round(rounded / 100) * 100;
  } else if (rounded < 5000) {
    // 1000-5000: bulatkan ke kelipatan 500
    return Math.round(rounded / 500) * 500;
  } else if (rounded < 10000) {
    // 5000-10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  } else {
    // Di atas 10000: bulatkan ke kelipatan 1000
    return Math.round(rounded / 1000) * 1000;
  }
}

function formatRp(num) {
  if (isNaN(num) || !isFinite(num)) return 'Rp 0';
  return 'Rp ' + Math.round(num).toLocaleString('id-ID');
}

function getCategoryLabel(cat) {
  const map = { takoyaki: 'üêô Takoyaki', dimsum: 'ü•ü Dimsum', ayam: 'üçó Ayam Crispy', lainnya: 'üç± Lainnya' };
  return map[cat] || cat;
}

function getCategoryEmoji(cat) {
  const map = { takoyaki: 'üêô', dimsum: 'ü•ü', ayam: 'üçó', lainnya: 'üç±' };
  return map[cat] || 'üçΩÔ∏è';
}

function pilihHarga(el, type) {
  // Reset semua border di row yang sama
  const parent = el.parentElement;
  parent.querySelectorAll('.price-option').forEach(p => {
    p.style.borderColor = '#D1FAE5';
    p.style.background = '#FFFAF5';
  });
  
  // Highlight yang diklik
  el.style.borderColor = 'var(--green)';
  el.style.background = '#F0FDF4';
  
  // Toast feedback
  const margin = el.getAttribute('data-margin');
  const typeLabel = type === 'online' ? 'Online (GoFood/Shopee)' : 'Offline';
  showToast(`‚úÖ Dipilih: ${typeLabel} - Margin ${margin}%`);
}

function resetForm() {
  document.getElementById('nama-menu').value = '';
  document.getElementById('porsi').value = '6';
  document.getElementById('biaya-kemasan').value = '500';
  document.getElementById('bahan-list').innerHTML = '';
  document.getElementById('biaya-list').innerHTML = '';
  document.getElementById('hasil-section').style.display = 'none';
  
  // Reset foto
  document.getElementById('foto-menu').value = '';
  document.getElementById('preview-foto').innerHTML = '';
  currentFotoBase64 = null;
  
  bahanCount = 0; biayaCount = 0;
  tambahBahan(); tambahBahan(); tambahBahan();
  tambahBiaya();
}

function konfirmasiMenuBaru() {
  if (confirm('Reset form untuk input menu baru?\nData yang belum disimpan ke Ringkasan akan hilang.')) {
    resetForm();
    lastSnapshot = {};
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function cetakHasil() {
  window.print();
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

// =====================
// PROMO - SWITCH PANEL
// =====================
let bundleCount = 0;

function switchPromo(type, el) {
  document.querySelectorAll('.promo-type-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.promo-panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-' + type).classList.add('active');
  if (type === 'diskon') refreshDropdownDiskon();
  if (type === 'bundling') refreshAllBundleDropdowns();
}

function refreshAllBundleDropdowns() {
  document.querySelectorAll('.bundle-item-row').forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];
    const sel = row.querySelector('select');
    if (!sel) return;
    const currentNama = (document.getElementById('bname-' + id) || {}).value || '';
    sel.innerHTML = getBundleMenuOptions(currentNama);
  });
}

// =====================
// DROPDOWN DARI RINGKASAN
// =====================
function refreshDropdownDiskon() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const sel = document.getElementById('d-pilih-menu');
  const current = sel.value;

  sel.innerHTML = '<option value="">‚Äî Pilih menu yang sudah dihitung HPP-nya ‚Äî</option>';

  if (data.length === 0) {
    sel.innerHTML += '<option value="" disabled>‚ö†Ô∏è Belum ada menu tersimpan di Ringkasan</option>';
    return;
  }

  data.forEach((m, i) => {
    const label = getCategoryLabel(m.kategori);
    sel.innerHTML += `<option value="${i}">${label} ${m.nama} ‚Äî HPP: ${formatRp(m.hpp)}</option>`;
  });

  // Pertahankan pilihan sebelumnya jika masih ada
  if (current !== '') sel.value = current;
}

function isiDariRingkasan() {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = document.getElementById('d-pilih-menu').value;

  if (idx === '') {
    document.getElementById('d-menu-info').style.display = 'none';
    return;
  }

  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Isi form
  document.getElementById('d-nama').value = menu.nama;
  document.getElementById('d-hpp').value = Math.round(menu.hpp);
  document.getElementById('d-harga-normal').value = Math.round(menu.hargaJual);

  // Tampilkan info card
  document.getElementById('d-menu-info').style.display = 'block';
  document.getElementById('d-menu-info-nama').textContent = menu.nama;
  document.getElementById('d-menu-info-kategori').textContent = getCategoryLabel(menu.kategori) + ' ¬∑ Tersimpan ' + menu.tanggal;
  document.getElementById('d-menu-info-hpp').textContent = formatRp(menu.hpp);
  document.getElementById('d-menu-info-hj').textContent = formatRp(menu.hargaJual);

  // Langsung hitung
  hitungDiskon();
}

// =====================
// PROMO - DISKON %
// =====================
function updateDiskonSlider() {
  const val = document.getElementById('d-diskon').value;
  document.getElementById('d-diskon-label').textContent = val + '%';
}

function hitungDiskon() {
  const hpp = parseFloat(document.getElementById('d-hpp').value) || 0;
  const hargaNormal = parseFloat(document.getElementById('d-harga-normal').value) || 0;
  const diskon = parseFloat(document.getElementById('d-diskon').value) || 0;
  const platformFee = parseFloat(document.getElementById('d-platform-fee').value) || 0;
  const nama = document.getElementById('d-nama').value || 'Menu';

  if (hpp === 0 || hargaNormal === 0) return;

  const hargaSetelahDiskon = hargaNormal * (1 - diskon / 100);
  const pendapatanBersih = hargaSetelahDiskon * (1 - platformFee / 100);
  const profitPerPcs = pendapatanBersih - hpp;
  const marginNormal = ((hargaNormal * (1 - platformFee / 100) - hpp) / (hargaNormal * (1 - platformFee / 100))) * 100;
  const marginPromo = pendapatanBersih > 0 ? ((profitPerPcs) / pendapatanBersih) * 100 : 0;
  const minHargaDiskon = hpp / (1 - platformFee / 100);

  const isProfit = profitPerPcs > 0;
  const isDangerous = profitPerPcs < 0;
  const isWarning = profitPerPcs >= 0 && profitPerPcs < hpp * 0.1;

  let boxClass = isProfit && !isWarning ? 'profit' : isWarning ? 'warning' : 'danger';

  let verdictText = '';
  if (isDangerous) {
    verdictText = `‚ö†Ô∏è <strong>BONCOS!</strong> Promo diskon ${diskon}% ini bikin kamu rugi ${formatRp(Math.abs(profitPerPcs))} per pcs. Minimal harga jual setelah diskon harus <strong>${formatRp(Math.ceil(minHargaDiskon))}</strong> biar balik modal.`;
  } else if (isWarning) {
    verdictText = `üò¨ <strong>Hati-hati!</strong> Masih untung tipis (${marginPromo.toFixed(1)}%). Promo ini oke buat menarik pelanggan baru tapi jangan kelamaan ya. Maksimal 7‚Äì14 hari.`;
  } else {
    verdictText = `‚úÖ <strong>Aman dijalankan!</strong> Margin promo masih ${marginPromo.toFixed(1)}%, turun dari ${marginNormal.toFixed(1)}% normal. Cocok buat promo pembukaan atau flash sale!`;
  }

  const el = document.getElementById('diskon-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        üìä Hasil Simulasi: ${nama} Diskon ${diskon}%
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Harga Normal</span>
          <div class="pri-value">${formatRp(hargaNormal)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Harga Setelah Diskon</span>
          <div class="pri-value">${formatRp(hargaSetelahDiskon)}</div>
          <div class="pri-sub">hemat ${formatRp(hargaNormal - hargaSetelahDiskon)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan Bersih/pcs</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">setelah platform fee ${platformFee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit / Rugi per Pcs</span>
          <div class="pri-value">${profitPerPcs >= 0 ? '+' : ''}${formatRp(profitPerPcs)}</div>
          <div class="pri-sub">margin ${marginPromo.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdictText}
      </div>
    </div>
  `;
}

// =====================
// PROMO - BUNDLING
// =====================
function getBundleMenuOptions(selectedNama = '') {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  let opts = `<option value="">‚Äî Pilih dari ringkasan ‚Äî</option>`;
  data.forEach((m, i) => {
    const sel = m.nama === selectedNama ? 'selected' : '';
    opts += `<option value="${i}" ${sel}>${getCategoryLabel(m.kategori)} ${m.nama}</option>`;
  });
  if (data.length === 0) opts += `<option value="" disabled>‚ö†Ô∏è Belum ada menu tersimpan</option>`;
  return opts;
}

function tambahBundleItem() {
  bundleCount++;
  const id = bundleCount;
  const div = document.createElement('div');
  div.className = 'bundle-item-row';
  div.id = 'bundle-' + id;
  div.innerHTML = `
    <select onchange="isiBundle(${id}, this)" style="font-size:13px;padding:10px 12px;border:2px solid var(--border);border-radius:10px;font-family:'Nunito',sans-serif;font-weight:700;background:var(--bg);outline:none;width:100%;">
      ${getBundleMenuOptions()}
    </select>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhpp-display-${id}" style="font-size:10px;font-weight:800;color:var(--muted);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhpp-${id}" min="0" step="any" placeholder="HPP/pcs" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;">
      <div id="bhj-display-${id}" style="font-size:10px;font-weight:800;color:var(--green);padding:2px 4px;min-height:16px;"></div>
      <input type="number" id="bhj-${id}" min="0" step="any" placeholder="Harga jual" oninput="hitungBundling()" style="font-size:13px;" />
    </div>
    <input type="number" id="bqty-${id}" min="1" step="1" value="1" oninput="hitungBundling()" style="font-size:13px;" />
    <button class="btn btn-danger" onclick="hapusBundleItem(${id})">‚úï</button>
  `;
  document.getElementById('bundle-list').appendChild(div);
  hitungBundling();
}

function isiBundle(id, selectEl) {
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const idx = selectEl.value;
  if (idx === '') return;
  const menu = data[parseInt(idx)];
  if (!menu) return;

  // Set HPP dan Harga Jual
  document.getElementById('bhpp-' + id).value = Math.round(menu.hpp);
  document.getElementById('bhj-' + id).value = Math.round(menu.hargaJual);
  document.getElementById('bhpp-display-' + id).textContent = 'HPP: ' + formatRp(menu.hpp);
  document.getElementById('bhj-display-' + id).innerHTML = 'üí∞ Jual: ' + formatRp(menu.hargaJual);
  
  hitungBundling();
}

function hapusBundleItem(id) {
  const el = document.getElementById('bundle-' + id);
  if (el) { el.remove(); hitungBundling(); }
}

function hitungBundling() {
  let totalHPP = 0;
  let totalHargaJualNormal = 0;
  const itemDetail = [];

  // Cari semua row bundle
  const rows = document.querySelectorAll('.bundle-item-row');
  rows.forEach(row => {
    const idMatch = row.id.match(/bundle-(\d+)/);
    if (!idMatch) return;
    const id = idMatch[1];

    const selectEl  = row.querySelector('select');
    const hppInput  = document.getElementById('bhpp-' + id);
    const hjInput   = document.getElementById('bhj-' + id);
    const qtyInput  = document.getElementById('bqty-' + id);

    if (!selectEl || !hppInput) return;

    const nama  = selectEl.options[selectEl.selectedIndex]?.text || '';
    const hpp   = parseFloat(hppInput.value) || 0;
    const hj    = parseFloat(hjInput ? hjInput.value : 0) || 0;
    const qty   = parseFloat(qtyInput ? qtyInput.value : 1) || 1;

    if (!nama || hpp === 0 || selectEl.value === '') return;

    const subtotalHPP = hpp * qty;
    const subtotalHJ  = hj * qty;
    totalHPP += subtotalHPP;
    totalHargaJualNormal += subtotalHJ;
    itemDetail.push({ nama, hpp, hj, qty, subtotalHPP, subtotalHJ });
  });

  if (totalHPP === 0) {
    document.getElementById('bundling-result').style.display = 'none';
    return;
  }

  const platformFee = 20; // Platform fee default GoFood/Shopee

  // REKOMENDASI OFFLINE (tanpa platform fee)
  const offlineHemat = roundHargaMakanan(totalHPP / (1 - 0.10)); // Margin 10%
  const offlineStandar = roundHargaMakanan(totalHPP / (1 - 0.25)); // Margin 25%
  const offlinePremium = roundHargaMakanan(totalHPP / (1 - 0.35)); // Margin 35%

  // REKOMENDASI ONLINE (dengan platform fee, markup 1.25x dari offline)
  const onlineHemat = roundHargaMakanan(offlineHemat * 1.25); // 25% markup dari offline
  const onlineStandar = roundHargaMakanan(offlineStandar * 1.25);
  const onlinePremium = roundHargaMakanan(offlinePremium * 1.25);

  // Hitung profit untuk setiap skenario
  const profitOfflineHemat = offlineHemat - totalHPP;
  const profitOfflineStandar = offlineStandar - totalHPP;
  const profitOfflinePremium = offlinePremium - totalHPP;

  const profitOnlineHemat = (onlineHemat * (1 - platformFee/100)) - totalHPP;
  const profitOnlineStandar = (onlineStandar * (1 - platformFee/100)) - totalHPP;
  const profitOnlinePremium = (onlinePremium * (1 - platformFee/100)) - totalHPP;

  const normalInfo = totalHargaJualNormal > 0
    ? `<div style="font-size:12px;color:#666;margin-bottom:12px;">üí∞ Total harga satuan: <strong>${formatRp(totalHargaJualNormal)}</strong> ‚Üí hemat <strong>${formatRp(totalHargaJualNormal - offlineStandar)}</strong> dengan paket standar</div>`
    : '';

  const el = document.getElementById('bundling-result');
  el.style.display = 'block';
  el.innerHTML = `
    ${normalInfo}
    
    <div style="background:#FFF3E0;border-left:4px solid #FF9800;padding:14px;border-radius:8px;margin-bottom:12px;">
      <div style="font-weight:800;color:#E65100;margin-bottom:10px;">üí° Rekomendasi Harga Bundling</div>
      
      <!-- Header kolom -->
      <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;font-size:11px;font-weight:700;color:#666;">
        <div></div>
        <div style="text-align:center;">üè™ OFFLINE</div>
        <div style="text-align:center;">üì± ONLINE<br><span style="font-size:9px;font-weight:400;">(GoFood/Shopee)</span></div>
      </div>

      <!-- Row 1: Hemat -->
      <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;">
        <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
          üü° HEMAT<br><span style="font-size:10px;font-weight:400;color:#999;">Margin ~10%</span>
        </div>
        <div style="background:#FFFAF5;padding:10px;border-radius:8px;text-align:center;border:2px solid #eee;">
          <div style="font-weight:800;color:#E65100;font-size:16px;">${formatRp(offlineHemat)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOfflineHemat)}</div>
        </div>
        <div style="background:#FFFAF5;padding:10px;border-radius:8px;text-align:center;border:2px solid #eee;">
          <div style="font-weight:800;color:#E65100;font-size:16px;">${formatRp(onlineHemat)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOnlineHemat)}</div>
        </div>
      </div>

      <!-- Row 2: Standar (recommended) -->
      <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;margin-bottom:8px;">
        <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
          üü¢ STANDAR<br><span style="font-size:10px;font-weight:400;color:#999;">Margin ~25%</span>
        </div>
        <div style="background:#E8F5E9;padding:10px;border-radius:8px;text-align:center;border:2px solid #4CAF50;">
          <div style="font-weight:800;color:#2E7D32;font-size:16px;">${formatRp(offlineStandar)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOfflineStandar)}</div>
        </div>
        <div style="background:#E8F5E9;padding:10px;border-radius:8px;text-align:center;border:2px solid #4CAF50;">
          <div style="font-weight:800;color:#2E7D32;font-size:16px;">${formatRp(onlineStandar)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOnlineStandar)}</div>
        </div>
      </div>

      <!-- Row 3: Premium -->
      <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;">
        <div style="display:flex;align-items:center;font-weight:700;font-size:12px;color:#666;">
          üî• PREMIUM<br><span style="font-size:10px;font-weight:400;color:#999;">Margin ~35%</span>
        </div>
        <div style="background:#FFFAF5;padding:10px;border-radius:8px;text-align:center;border:2px solid #eee;">
          <div style="font-weight:800;color:#1976D2;font-size:16px;">${formatRp(offlinePremium)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOfflinePremium)}</div>
        </div>
        <div style="background:#FFFAF5;padding:10px;border-radius:8px;text-align:center;border:2px solid #eee;">
          <div style="font-weight:800;color:#1976D2;font-size:16px;">${formatRp(onlinePremium)}</div>
          <div style="font-size:10px;color:#666;margin-top:2px;">Profit: ${formatRp(profitOnlinePremium)}</div>
        </div>
      </div>

      <div style="font-size:11px;color:#666;margin-top:10px;padding-top:10px;border-top:1px solid #ddd;">
        ‚ÑπÔ∏è <strong>Harga online 25% lebih tinggi</strong> untuk cover platform fee ~20%. Profit tetap sama antara offline & online.
      </div>
    </div>
    
    <div class="card">
      <div class="card-title" style="margin-bottom:12px;">üîç Detail Item Bundling</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Item</th>
            <th class="text-right">Qty</th>
            <th class="text-right">HPP/pcs</th>
            <th class="text-right">Harga Jual/pcs</th>
            <th class="text-right">Subtotal HPP</th>
          </tr>
        </thead>
        <tbody>
          ${itemDetail.map(i => `
            <tr>
              <td>${i.nama}</td>
              <td class="text-right">${i.qty}x</td>
              <td class="text-right">${formatRp(i.hpp)}</td>
              <td class="text-right">${i.hj > 0 ? formatRp(i.hj) : '<span style="color:var(--muted)">‚Äî</span>'}</td>
              <td class="text-right">${formatRp(i.subtotalHPP)}</td>
            </tr>`).join('')}
          <tr style="border-top:2px solid var(--border);font-weight:800;">
            <td colspan="4" style="text-align:right;padding-top:8px;">Total HPP Paket:</td>
            <td class="text-right" style="padding-top:8px;color:var(--red);">${formatRp(totalHPP)}</td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

// =====================
// PROMO - BELI X GRATIS Y
// =====================
function hitungBeliGratis() {
  // Gunakan harga jual normal aktual kalau tersedia, fallback ke estimasi margin 50%
  const hargaNormalRef = totalHargaJualNormal > 0 ? totalHargaJualNormal : totalHPP / (1 - 0.5);
  const diskonEfektif = hargaNormalRef > 0 ? ((hargaNormalRef - hargaPaket) / hargaNormalRef) * 100 : 0;

  const isProfit = profit > 0;
  const isWarning = profit >= 0 && margin < 15;
  let boxClass = !isProfit ? 'danger' : isWarning ? 'warning' : 'profit';

  let verdict = '';
  if (!isProfit) {
    verdict = `‚ö†Ô∏è <strong>Harga paket terlalu murah!</strong> Kamu rugi ${formatRp(Math.abs(profit))} per transaksi. Naikkan harga paket minimal <strong>${formatRp(Math.ceil(totalHPP / (1 - platformFee / 100)))}</strong> buat balik modal.`;
  } else if (isWarning) {
    verdict = `üò¨ <strong>Margin tipis (${margin.toFixed(1)}%).</strong> Masih untung tapi mepet. Cocok buat promo perdana/launching, tapi jangan jadi harga tetap ya.`;
  } else {
    const diskonStr = diskonEfektif > 0 ? `~${Math.abs(diskonEfektif).toFixed(0)}% lebih murah dari beli satuan` : 'lebih hemat dari beli satuan';
    verdict = `‚úÖ <strong>Bundling ini sehat!</strong> Margin ${margin.toFixed(1)}% ‚Äî paket ini ${diskonStr}. Pelanggan senang, kamu tetap untung!`;
  }

  let itemRows = itemDetail.map(i => `
    <tr>
      <td>${i.nama}</td>
      <td class="text-right">${i.qty}x</td>
      <td class="text-right">${formatRp(i.hpp)}</td>
      <td class="text-right">${i.hj > 0 ? formatRp(i.hj) : '<span style="color:var(--muted)">‚Äî</span>'}</td>
      <td class="text-right">${formatRp(i.subtotalHPP)}</td>
    </tr>`).join('');

  const normalInfo = totalHargaJualNormal > 0
    ? `<span style="font-size:12px;opacity:0.85;">Harga jual normal: <strong>${formatRp(totalHargaJualNormal)}</strong> ‚Üí hemat <strong>${formatRp(totalHargaJualNormal - hargaPaket)}</strong></span>`
    : '';

  const el = document.getElementById('bundling-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:4px;">üì¶ Hasil Simulasi Bundling</div>
      ${normalInfo}
      <div class="promo-result-grid" style="margin-top:12px;">
        <div class="promo-result-item">
          <span class="pri-label">Total HPP Paket</span>
          <div class="pri-value">${formatRp(totalHPP)}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Harga Jual Paket</span>
          <div class="pri-value">${formatRp(hargaPaket)}</div>
          ${diskonEfektif > 0 ? `<div class="pri-sub">diskon efektif ${diskonEfektif.toFixed(0)}%</div>` : ''}
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan Bersih</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">setelah fee ${platformFee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit per Transaksi</span>
          <div class="pri-value">${profit >= 0 ? '+' : ''}${formatRp(profit)}</div>
          <div class="pri-sub">margin ${margin.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdict}
      </div>
    </div>
    <div class="card" style="margin-top:12px;">
      <div class="card-title" style="margin-bottom:12px;">üîç Detail Item Bundling</div>
      <table class="breakdown-table">
        <thead>
          <tr>
            <th>Item</th>
            <th class="text-right">Qty</th>
            <th class="text-right">HPP/pcs</th>
            <th class="text-right">Harga Jual/pcs</th>
            <th class="text-right">Subtotal HPP</th>
          </tr>
        </thead>
        <tbody>
          ${itemRows}
          <tr class="total-row">
            <td colspan="2"><strong>TOTAL</strong></td>
            <td></td>
            <td class="text-right"><strong>${totalHargaJualNormal > 0 ? formatRp(totalHargaJualNormal) : '‚Äî'}</strong></td>
            <td class="text-right"><strong>${formatRp(totalHPP)}</strong></td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
}

// =====================
// PROMO - BELI X GRATIS Y
// =====================
function refreshDropdownBeliGratis() {
  const sel = document.getElementById('bg-menu-select');
  if (!sel) return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  let opts = '<option value="">üîç Pilih dari Ringkasan Menu...</option>';
  
  data.forEach((m, i) => {
    opts += `<option value="${i}">${getCategoryEmoji(m.kategori)} ${m.nama} ‚Äî HPP: ${formatRp(m.hpp)} | Jual: ${formatRp(m.hargaJual)}</option>`;
  });
  
  if (data.length === 0) opts += '<option value="" disabled>‚ö†Ô∏è Belum ada menu tersimpan</option>';
  sel.innerHTML = opts;
}

function isiBeliGratis() {
  const sel = document.getElementById('bg-menu-select');
  const idx = sel.value;
  if (idx === '') return;
  
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = data[parseInt(idx)];
  if (!menu) return;
  
  document.getElementById('bg-hpp').value = Math.round(menu.hpp);
  document.getElementById('bg-harga').value = Math.round(menu.hargaJual);
  hitungBeliGratis();
  showToast(`‚úÖ ${menu.nama} dipilih`);
}

function toggleBeliGratisChannel() {
  const channel = document.getElementById('bg-channel').value;
  const feeRow = document.getElementById('bg-fee-row');
  
  if (channel === 'offline') {
    // Offline - hide platform fee
    if (feeRow) feeRow.style.display = 'none';
    document.getElementById('bg-fee').value = 0;
  } else {
    // Online - show platform fee
    if (feeRow) feeRow.style.display = 'grid';
    document.getElementById('bg-fee').value = 20;
  }
  
  hitungBeliGratis();
}

function hitungBeliGratis() {
  const beli = parseFloat(document.getElementById('bg-beli').value) || 1;
  const gratis = parseFloat(document.getElementById('bg-gratis').value) || 1;
  const hpp = parseFloat(document.getElementById('bg-hpp').value) || 0;
  const harga = parseFloat(document.getElementById('bg-harga').value) || 0;
  const fee = parseFloat(document.getElementById('bg-fee').value) || 0;
  const transaksiPerHari = parseFloat(document.getElementById('bg-transaksi').value) || 1;

  if (hpp === 0 || harga === 0) return;

  const totalUnit = beli + gratis;
  const totalBayar = beli * harga;
  const totalHPP = totalUnit * hpp;
  const pendapatanBersih = totalBayar * (1 - fee / 100);
  const profitPerTransaksi = pendapatanBersih - totalHPP;
  const marginPerTransaksi = pendapatanBersih > 0 ? (profitPerTransaksi / pendapatanBersih) * 100 : 0;
  const hargaEfektif = totalBayar / totalUnit; // harga rata-rata yang dibayar per pcs
  const diskonEfektif = ((harga - hargaEfektif) / harga) * 100;

  // Estimasi dampak harian
  const profitHarian = profitPerTransaksi * transaksiPerHari;
  const profitHarianNormal = (harga * (1 - fee / 100) - hpp) * beli * transaksiPerHari;

  const isProfit = profitPerTransaksi > 0;
  const isWarning = profitPerTransaksi >= 0 && marginPerTransaksi < 10;
  let boxClass = !isProfit ? 'danger' : isWarning ? 'warning' : 'profit';

  let verdict = '';
  if (!isProfit) {
    verdict = `‚ö†Ô∏è <strong>Boncos!</strong> Promo beli ${beli} gratis ${gratis} ini rugi ${formatRp(Math.abs(profitPerTransaksi))} per transaksi. Harga jualmu terlalu rendah untuk menanggung item gratis. Coba naikkan harga jual ke minimal ${formatRp(Math.ceil(totalHPP / (1 - fee / 100) / beli))} per pcs.`;
  } else if (isWarning) {
    verdict = `üò¨ <strong>Margin sangat tipis (${marginPerTransaksi.toFixed(1)}%).</strong> Masih bisa jalan tapi riskan. Promo ini setara diskon efektif ${diskonEfektif.toFixed(1)}%. Batasi durasi promo maksimal 1 minggu.`;
  } else {
    verdict = `‚úÖ <strong>Promo ini layak!</strong> Beli ${beli} gratis ${gratis} = diskon efektif ${diskonEfektif.toFixed(1)}% di mata pelanggan. Kamu tetap untung ${formatRp(profitPerTransaksi)} per transaksi!`;
  }

  const el = document.getElementById('beli-gratis-result');
  el.style.display = 'block';
  el.innerHTML = `
    <div class="promo-result-box ${boxClass}">
      <div style="font-family:'Fredoka One',cursive;font-size:17px;margin-bottom:12px;">
        üéÅ Hasil: Beli ${beli} Gratis ${gratis}
      </div>
      <div class="promo-result-grid">
        <div class="promo-result-item">
          <span class="pri-label">Total Unit Keluar</span>
          <div class="pri-value">${totalUnit} pcs</div>
          <div class="pri-sub">beli ${beli} + gratis ${gratis}</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Pendapatan per Transaksi</span>
          <div class="pri-value">${formatRp(pendapatanBersih)}</div>
          <div class="pri-sub">bayar ${beli}x${formatRp(harga)}, fee ${fee}%</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Diskon Efektif</span>
          <div class="pri-value">${diskonEfektif.toFixed(1)}%</div>
          <div class="pri-sub">persepsi pelanggan</div>
        </div>
        <div class="promo-result-item">
          <span class="pri-label">Profit per Transaksi</span>
          <div class="pri-value">${profitPerTransaksi >= 0 ? '+' : ''}${formatRp(profitPerTransaksi)}</div>
          <div class="pri-sub">margin ${marginPerTransaksi.toFixed(1)}%</div>
        </div>
      </div>
      <div class="verdict-box">
        <div class="verdict-title">Verdict</div>
        ${verdict}
        <div style="margin-top:8px;font-size:12px;opacity:0.9;">
          üìÖ Estimasi dampak harian (${transaksiPerHari} transaksi/hari): 
          <strong>${profitHarian >= 0 ? '+' : ''}${formatRp(profitHarian)}</strong> profit
          vs <strong>+${formatRp(profitHarianNormal)}</strong> tanpa promo
        </div>
      </div>
    </div>
  `;
}

// =====================
// CLOUD SYNC (Google Sheets)
// =====================

function debugLog(msg, isError = false) {
  const debugEl = document.getElementById('debug-log');
  if (debugEl) {
    debugEl.style.display = 'block';
    const time = new Date().toLocaleTimeString('id-ID');
    const color = isError ? '#F38BA8' : '#A6E3A1';
    debugEl.innerHTML += `<div style="color:${color};margin-bottom:4px;">[${time}] ${msg}</div>`;
    debugEl.scrollTop = debugEl.scrollHeight;
  }
}

function getSheetsUrl() {
  return localStorage.getItem('kedaiHeula_sheetsUrl') || '';
}

function updateSyncStatus() {
  const url = getSheetsUrl();
  const lastSync = localStorage.getItem('kedaiHeula_lastSync');
  const el = document.getElementById('sync-status');
  if (!el) return;
  if (!url) {
    el.textContent = 'Belum dikonfigurasi ‚Äî klik Setup untuk mulai';
    el.style.color = 'var(--muted)';
  } else if (lastSync) {
    el.textContent = '‚úÖ Terakhir sync: ' + lastSync;
    el.style.color = 'var(--green)';
  } else {
    el.textContent = '‚ö†Ô∏è URL tersimpan, belum pernah sync';
    el.style.color = 'var(--orange)';
  }
}

function bukaSyncConfig() {
  const url = getSheetsUrl();
  if (url) document.getElementById('sheets-url-input').value = url;
  
  // Clear debug log
  const debugEl = document.getElementById('debug-log');
  if (debugEl) {
    debugEl.innerHTML = '';
    debugEl.style.display = 'none';
  }
  
  document.getElementById('modal-sync').style.display = 'flex';
}

function tutupSyncConfig() {
  document.getElementById('modal-sync').style.display = 'none';
}

async function simpanSyncConfig() {
  const url = document.getElementById('sheets-url-input').value.trim();
  if (!url || !url.startsWith('https://script.google.com')) {
    alert('URL tidak valid. Pastikan URL dimulai dengan https://script.google.com');
    return;
  }
  localStorage.setItem('kedaiHeula_sheetsUrl', url);
  tutupSyncConfig();
  showToast('‚úÖ URL tersimpan! Mencoba koneksi...');
  // Test koneksi
  await syncKeSheets(true);
}

async function syncKeSheets(isTest = false) {
  const url = getSheetsUrl();
  if (!url) {
    bukaSyncConfig();
    return;
  }
  const data = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  if (!isTest && data.length === 0) {
    showToast('‚ö†Ô∏è Tidak ada data untuk di-backup');
    return;
  }

  const btnSync = document.getElementById('btn-sync');
  const origText = btnSync.innerHTML;
  btnSync.innerHTML = '‚è≥ Menyimpan...';
  btnSync.disabled = true;

  try {
    debugLog('üîÑ Mulai backup...');
    debugLog('üìç URL: ' + url.substring(0, 50) + '...');
    debugLog('üì¶ Data: ' + data.length + ' menu');
    
    // Log ukuran foto untuk debug
    data.forEach((item, i) => {
      if (item.foto) {
        const sizeKB = Math.round(item.foto.length / 1024);
        debugLog(`üì∏ ${item.nama}: foto ${sizeKB}KB`);
      }
    });
    
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'backup', data: data }),
      redirect: 'follow'
    });
    
    debugLog('üì° Response status: ' + res.status);
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    debugLog('‚úÖ Response: ' + JSON.stringify(result).substring(0, 100));
    
    if (result.status === 'ok') {
      const now = getWIBDateTimeString();
      localStorage.setItem('kedaiHeula_lastSync', now);
      updateSyncStatus();
      debugLog('‚úÖ Backup berhasil!');
      showToast(isTest ? '‚úÖ Koneksi berhasil! Data tersimpan.' : `‚úÖ Backup berhasil! ${data.length} menu tersimpan.`);
    } else {
      throw new Error(result.message || 'Unknown error');
    }
  } catch (e) {
    debugLog('‚ùå ERROR: ' + e.message, true);
    
    let errorMsg = 'Gagal backup';
    
    if (e.message.includes('Failed to fetch')) {
      errorMsg += ': Cek URL atau deploy ulang Apps Script';
      debugLog('üí° TIP: Buka Setup ‚Üí cek URL sudah benar', true);
    } else if (e.message.includes('HTTP 404')) {
      errorMsg += ': URL tidak ditemukan';
      debugLog('üí° TIP: Deploy ulang Apps Script ‚Üí copy URL baru', true);
    } else if (e.message.includes('HTTP 403')) {
      errorMsg += ': Permission ditolak';
      debugLog('üí° TIP: Set "Who has access" = Anyone di Apps Script', true);
    } else {
      errorMsg += ': ' + e.message;
    }
    
    showToast('‚ùå ' + errorMsg);
  } finally {
    btnSync.innerHTML = origText;
    btnSync.disabled = false;
  }
}

async function restoreFromSheets() {
  const url = getSheetsUrl();
  if (!url) {
    bukaSyncConfig();
    return;
  }
  
  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const lokalCount = lokal.length;
  
  let confirmMsg = 'Restore data dari Google Sheets?';
  if (lokalCount > 0) {
    confirmMsg += `\n\nData lokal: ${lokalCount} menu.\nData akan digabung (tidak dihapus).`;
  } else {
    confirmMsg += '\n\nData lokal kosong, akan diisi dari cloud.';
  }
  
  if (!confirm(confirmMsg)) return;

  const btnRestore = document.getElementById('btn-restore');
  const origText = btnRestore.innerHTML;
  btnRestore.innerHTML = '‚è≥ Memuat...';
  btnRestore.disabled = true;

  try {
    // CRITICAL: tambahkan ?action=restore ke URL untuk GET request
    const fetchUrl = url.includes('?') ? url + '&action=restore' : url + '?action=restore';
    const res = await fetch(fetchUrl, { 
      method: 'GET',
      redirect: 'follow'
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    
    if (result.status === 'ok' && Array.isArray(result.data)) {
      const cloud = result.data;
      
      if (cloud.length === 0) {
        showToast('‚ö†Ô∏è Tidak ada data di Google Sheets. Backup dulu sebelum restore.');
        return;
      }
      
      // Merge: gabungkan data cloud dengan lokal, hindari duplikat berdasarkan nama+tanggal
      const merged = [...lokal];
      let added = 0;
      
      cloud.forEach(item => {
        const exists = merged.some(m => m.nama === item.nama && m.tanggal === item.tanggal);
        if (!exists) {
          merged.push(item);
          added++;
        }
      });
      
      localStorage.setItem('kedaiHeula_menu', JSON.stringify(merged));
      menuList = merged;
      renderRingkasan();
      
      showToast(`‚úÖ Restore berhasil! ${cloud.length} menu dari cloud, ${added} menu baru ditambahkan. Total: ${merged.length} menu.`);
    } else {
      throw new Error(result.message || 'Data tidak valid dari server');
    }
  } catch (e) {
    showToast('‚ùå Gagal restore: ' + e.message);
    console.error('Restore error:', e);
  } finally {
    btnRestore.innerHTML = origText;
    btnRestore.disabled = false;
  }
}

// =====================
// LAPORAN PENJUALAN
// =====================

let currentPeriode = 'hari';
let chartProfit = null;

function initLaporan() {
  // Set tanggal hari ini (WIB)
  document.getElementById('transaksi-tanggal').value = getWIBDateString();
  
  // Populate dropdown menu
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const select = document.getElementById('transaksi-menu');
  select.innerHTML = '<option value="">-- Pilih Menu --</option>' +
    menuList.map((m, i) => `<option value="${i}">${m.nama} (${formatRp(m.hargaJual)})</option>`).join('');
  
  setPeriodeLaporan('semua'); // Default: tampilkan semua transaksi
}

function setTanggalTransaksi(mode) {
  const input = document.getElementById('transaksi-tanggal');
  const wib = getWIBDate();
  
  if (mode === 'kemarin') {
    wib.setDate(wib.getDate() - 1);
  }
  // mode 'hari-ini' tidak perlu ubah date
  
  const year = wib.getFullYear();
  const month = String(wib.getMonth() + 1).padStart(2, '0');
  const day = String(wib.getDate()).padStart(2, '0');
  input.value = `${year}-${month}-${day}`;
}

function isiHargaTransaksi() {
  const idx = parseInt(document.getElementById('transaksi-menu').value);
  if (isNaN(idx)) return;
  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const m = menuList[idx];
  if (!m) return;
  document.getElementById('transaksi-hpp').value = m.hpp;
  document.getElementById('transaksi-harga').value = m.hargaJual;
}

function simpanTransaksi() {
  const tanggal = document.getElementById('transaksi-tanggal').value;
  const menuIdx = parseInt(document.getElementById('transaksi-menu').value);
  const qty     = parseInt(document.getElementById('transaksi-qty').value) || 0;
  const hpp     = parseFloat(document.getElementById('transaksi-hpp').value) || 0;
  const harga   = parseFloat(document.getElementById('transaksi-harga').value) || 0;

  if (!tanggal || isNaN(menuIdx) || qty <= 0 || hpp <= 0 || harga <= 0) {
    alert('Isi semua field dengan benar');
    return;
  }

  const menuList = JSON.parse(localStorage.getItem('kedaiHeula_menu') || '[]');
  const menu = menuList[menuIdx];
  if (!menu) return;

  const transaksi = {
    id: Date.now() + Math.floor(Math.random() * 1000), // Tambah random untuk hindari collision
    tanggal: tanggal,
    menu: menu.nama,
    qty: qty,
    hpp: hpp,
    hargaJual: harga,
    profit: (harga - hpp) * qty,
    timestamp: getWIBDateTimeString() // WIB timezone
  };

  const listTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  listTransaksi.push(transaksi);
  localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(listTransaksi));

  console.log('Transaksi tersimpan:', transaksi);
  console.log('Total transaksi di localStorage:', listTransaksi.length);

  showToast(`‚úÖ Transaksi tersimpan! Profit: ${formatRp(transaksi.profit)}`);
  
  // Reset form
  document.getElementById('transaksi-qty').value = 1;
  document.getElementById('transaksi-menu').value = '';
  document.getElementById('transaksi-hpp').value = '';
  document.getElementById('transaksi-harga').value = '';
  
  // Re-render laporan untuk update tampilan
  renderLaporan();
}

function setPeriodeLaporan(periode) {
  currentPeriode = periode;
  ['hari', 'minggu', 'bulan', 'semua'].forEach(p => {
    const btn = document.getElementById(`btn-period-${p}`);
    if (btn) {
      if (p === periode) {
        btn.style.background = 'linear-gradient(135deg, var(--red), var(--orange))';
        btn.style.color = 'white';
        btn.style.borderColor = 'transparent';
      } else {
        btn.style.background = 'white';
        btn.style.color = 'var(--dark)';
        btn.style.borderColor = 'var(--border)';
      }
    }
  });
  renderLaporan();
}

function filterTransaksiByPeriode(transaksiList) {
  if (currentPeriode === 'semua') {
    return transaksiList; // Return semua tanpa filter
  }
  
  const wibNow = getWIBDate();
  wibNow.setHours(0, 0, 0, 0); // Reset ke awal hari
  const today = getWIBDateString(); // Format YYYY-MM-DD
  
  return transaksiList.filter(t => {
    const tDate = parseWIBDate(t.tanggal); // Parse dengan timezone WIB
    tDate.setHours(0, 0, 0, 0);
    
    if (currentPeriode === 'hari') {
      return t.tanggal === today;
    } else if (currentPeriode === 'minggu') {
      // 7 hari terakhir termasuk hari ini
      const weekAgo = new Date(wibNow);
      weekAgo.setDate(weekAgo.getDate() - 6);
      return tDate >= weekAgo && tDate <= wibNow;
    } else {
      // Bulan ini = dari tanggal 1 bulan ini sampai hari ini
      const startOfMonth = new Date(wibNow.getFullYear(), wibNow.getMonth(), 1);
      return tDate >= startOfMonth && tDate <= wibNow;
    }
  });
}

function renderLaporan() {
  const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const filtered = filterTransaksiByPeriode(allTransaksi);

  // Summary
  const totalProfit = filtered.reduce((s, t) => s + t.profit, 0);
  const totalTransaksi = filtered.length;
  const totalItem = filtered.reduce((s, t) => s + t.qty, 0);

  document.getElementById('lap-profit').textContent = formatRp(totalProfit);
  document.getElementById('lap-transaksi').textContent = totalTransaksi;
  document.getElementById('lap-item').textContent = totalItem + ' pcs';

  // Breakdown per menu
  renderBreakdownMenu(filtered);

  // Chart
  renderChart(filtered);

  // Tabel
  renderTabelTransaksi(filtered);
}

function renderBreakdownMenu(transaksiList) {
  const container = document.getElementById('breakdown-menu');
  
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  // Group by menu
  const byMenu = {};
  transaksiList.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  // Sort by profit descending
  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  const totalProfit = menuList.reduce((s, m) => s + m.profit, 0);

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th>Menu</th>
        <th class="text-right">Qty Terjual</th>
        <th class="text-right">Transaksi</th>
        <th class="text-right">Total Profit</th>
        <th class="text-right">% Kontribusi</th>
        <th class="text-right">Avg/Item</th>
      </tr>
    </thead>
    <tbody>`;

  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3; // Top 3 menu
    
    const bgColor = isTop ? '#FFF8E6' : '';
    const badge = isTop ? ['ü•á','ü•à','ü•â'][idx] : '';
    
    html += `<tr style="background:${bgColor};">
      <td>
        ${badge ? `<span style="font-size:16px;margin-right:6px;">${badge}</span>` : ''}
        <strong style="color:${isTop ? 'var(--orange)' : 'inherit'};">${item.menu}</strong>
      </td>
      <td class="text-right">${item.qty} pcs</td>
      <td class="text-right">${item.transaksi}x</td>
      <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(item.profit)}</td>
      <td class="text-right">
        <div style="display:flex;align-items:center;justify-content:flex-end;gap:6px;">
          <div style="background:#E8F5E9;height:20px;width:${Math.min(percentage, 100)}%;min-width:2px;border-radius:4px;"></div>
          <span style="font-weight:700;font-size:11px;color:var(--green);">${percentage.toFixed(1)}%</span>
        </div>
      </td>
      <td class="text-right">${formatRp(avgProfit)}</td>
    </tr>`;
  });

  // Total row
  const totalQty = menuList.reduce((s, m) => s + m.qty, 0);
  const totalTransaksi = menuList.reduce((s, m) => s + m.transaksi, 0);

  html += `<tr class="total-row">
    <td><strong>Total</strong></td>
    <td class="text-right"><strong>${totalQty} pcs</strong></td>
    <td class="text-right"><strong>${totalTransaksi}x</strong></td>
    <td class="text-right"><strong>${formatRp(totalProfit)}</strong></td>
    <td class="text-right"><strong>100%</strong></td>
    <td class="text-right">‚Äî</td>
  </tr>`;

  html += '</tbody></table>';
  container.innerHTML = html;
}

function renderChart(transaksiList) {
  const ctx = document.getElementById('chart-profit');
  if (!ctx) return;

  if (transaksiList.length === 0) {
    if (chartProfit) chartProfit.destroy();
    ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
    return;
  }

  // Group by date
  const byDate = {};
  transaksiList.forEach(t => {
    if (!byDate[t.tanggal]) byDate[t.tanggal] = 0;
    byDate[t.tanggal] += t.profit;
  });

  // Sort tanggal ascending (dari lama ke baru)
  const dates = Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b));
  const profits = dates.map(d => byDate[d]);

  // Format label tanggal
  const labels = dates.map(d => {
    const date = new Date(d + 'T00:00:00');
    return date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
  });

  if (chartProfit) chartProfit.destroy();

  chartProfit = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Profit (Rp)',
        data: profits,
        borderColor: '#E03027',
        backgroundColor: 'rgba(224, 48, 39, 0.1)',
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointBackgroundColor: '#E03027',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 4,
        pointHoverRadius: 6
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => 'Profit: Rp ' + ctx.parsed.y.toLocaleString('id-ID')
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: val => 'Rp ' + val.toLocaleString('id-ID')
          }
        }
      }
    }
  });
}

function renderTabelTransaksi(transaksiList) {
  const container = document.getElementById('tabel-transaksi');
  if (transaksiList.length === 0) {
    container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px;">Belum ada transaksi</p>';
    return;
  }

  let html = `<table class="breakdown-table">
    <thead>
      <tr>
        <th>Tanggal</th>
        <th>Menu</th>
        <th class="text-right">Qty</th>
        <th class="text-right">HPP</th>
        <th class="text-right">Harga Jual</th>
        <th class="text-right">Profit</th>
        <th></th>
      </tr>
    </thead>
    <tbody>`;

  transaksiList.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(t => {
    const displayDate = parseWIBDate(t.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    html += `<tr>
      <td>${displayDate}</td>
      <td>${t.menu}</td>
      <td class="text-right">${t.qty} pcs</td>
      <td class="text-right">${formatRp(t.hpp)}</td>
      <td class="text-right">${formatRp(t.hargaJual)}</td>
      <td class="text-right" style="font-weight:800;color:var(--green);">${formatRp(t.profit)}</td>
      <td><button class="btn-hapus-transaksi" data-id="${t.id}" title="Klik 2x untuk hapus" style="background:var(--red);color:white;border:none;border-radius:6px;font-size:11px;padding:4px 8px;cursor:pointer;font-weight:700;">üóëÔ∏è</button></td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;

  // Attach event listeners dengan double-click protection
  container.querySelectorAll('.btn-hapus-transaksi').forEach(btn => {
    let clickCount = 0;
    let clickTimer = null;
    
    btn.addEventListener('click', function() {
      const id = parseInt(this.getAttribute('data-id'));
      clickCount++;
      
      if (clickCount === 1) {
        // First click - warning visual
        this.style.background = '#F39C12';
        this.textContent = '‚ö†Ô∏è Klik lagi';
        
        clickTimer = setTimeout(() => {
          // Reset after 2 seconds
          clickCount = 0;
          this.style.background = 'var(--red)';
          this.textContent = 'üóëÔ∏è';
        }, 2000);
        
      } else if (clickCount === 2) {
        // Second click - delete
        clearTimeout(clickTimer);
        clickCount = 0;
        
        let list = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
        const before = list.length;
        
        list = list.filter(t => t.id !== id);
        const after = list.length;
        
        if (before === after) {
          console.error('Transaksi tidak ditemukan, ID:', id);
          showToast('‚ùå Transaksi tidak ditemukan');
          return;
        }
        
        localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(list));
        console.log(`Transaksi ID ${id} dihapus. Sisa: ${after} transaksi`);
        
        renderLaporan();
        showToast('üóëÔ∏è Transaksi dihapus');
      }
    });
  });
}

// =====================
// EXPORT LAPORAN PDF
// =====================

function syncTransaksiKeSheets() {
  const url = getSheetsUrl();
  if (!url) {
    alert('Setup Google Sheets dulu di tab Ringkasan Menu ‚Üí Setup Cloud Backup');
    return;
  }

  const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  if (allTransaksi.length === 0) {
    showToast('‚ö†Ô∏è Tidak ada transaksi untuk di-backup');
    return;
  }

  if (!confirm(`Backup ${allTransaksi.length} transaksi ke Google Sheets?`)) return;

  const origText = 'Menyimpan...';
  showToast('‚òÅÔ∏è ' + origText);

  fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' },
    body: JSON.stringify({ action: 'backup_transaksi', data: allTransaksi })
  })
  .then(res => res.json())
  .then(result => {
    if (result.status === 'ok') {
      const now = getWIBDateTimeString();
      localStorage.setItem('kedaiHeula_lastSyncTransaksi', now);
      showToast(`‚úÖ Backup transaksi berhasil! ${allTransaksi.length} transaksi tersimpan.`);
    } else {
      throw new Error(result.message || 'Unknown error');
    }
  })
  .catch(e => {
    showToast('‚ùå Gagal backup transaksi: ' + e.message);
    console.error(e);
  });
}

async function restoreTransaksiFromSheets() {
  const url = getSheetsUrl();
  if (!url) {
    alert('Setup Google Sheets dulu di tab Ringkasan Menu ‚Üí Setup Cloud Backup');
    return;
  }

  const lokal = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
  const lokalCount = lokal.length;
  
  let confirmMsg = 'Restore transaksi dari Google Sheets?';
  if (lokalCount > 0) {
    confirmMsg += `\n\nData lokal: ${lokalCount} transaksi.\nData akan digabung (tidak dihapus).`;
  } else {
    confirmMsg += '\n\nData lokal kosong, akan diisi dari cloud.';
  }
  
  if (!confirm(confirmMsg)) return;

  showToast('‚è≥ Memuat transaksi dari cloud...');

  try {
    const fetchUrl = url.includes('?') ? url + '&action=restore_transaksi' : url + '?action=restore_transaksi';
    const res = await fetch(fetchUrl, { 
      method: 'GET',
      redirect: 'follow'
    });
    
    if (!res.ok) {
      throw new Error(`HTTP ${res.status}: ${res.statusText}`);
    }
    
    const result = await res.json();
    
    if (result.status === 'ok' && Array.isArray(result.data)) {
      const cloud = result.data;
      
      if (cloud.length === 0) {
        showToast('‚ö†Ô∏è Tidak ada transaksi di Google Sheets. Backup dulu sebelum restore.');
        return;
      }
      
      // Merge: gabungkan data cloud dengan lokal, hindari duplikat berdasarkan id
      const merged = [...lokal];
      let added = 0;
      
      cloud.forEach(item => {
        const exists = merged.some(t => t.id === item.id);
        if (!exists) {
          merged.push(item);
          added++;
        }
      });
      
      localStorage.setItem('kedaiHeula_transaksi', JSON.stringify(merged));
      
      showToast(`‚úÖ Restore berhasil! ${cloud.length} transaksi dari cloud, ${added} transaksi baru ditambahkan. Total: ${merged.length} transaksi.`);
      
      // Re-render laporan
      renderLaporan();
    } else {
      throw new Error(result.message || 'Data tidak valid dari server');
    }
  } catch (e) {
    showToast('‚ùå Gagal restore: ' + e.message);
    console.error('Restore error:', e);
  }
}

function exportLaporanPDF() {
  try {
    const allTransaksi = JSON.parse(localStorage.getItem('kedaiHeula_transaksi') || '[]');
    const filtered = filterTransaksiByPeriode(allTransaksi);
    
    if (filtered.length === 0) {
      showToast('‚ö†Ô∏è Tidak ada transaksi untuk di-export');
      return;
    }

  // Summary data
  const totalProfit = filtered.reduce((s, t) => s + t.profit, 0);
  const totalTransaksi = filtered.length;
  const totalItem = filtered.reduce((s, t) => s + t.qty, 0);

  // Breakdown per menu
  const byMenu = {};
  filtered.forEach(t => {
    if (!byMenu[t.menu]) {
      byMenu[t.menu] = { qty: 0, profit: 0, transaksi: 0 };
    }
    byMenu[t.menu].qty += t.qty;
    byMenu[t.menu].profit += t.profit;
    byMenu[t.menu].transaksi += 1;
  });

  const menuList = Object.keys(byMenu).map(menu => ({
    menu: menu,
    ...byMenu[menu]
  })).sort((a, b) => b.profit - a.profit);

  // Periode label
  const periodeLabel = {
    'hari': 'Hari Ini',
    'minggu': '7 Hari Terakhir',
    'bulan': 'Bulan Ini',
    'semua': 'Semua Periode'
  }[currentPeriode] || 'Periode Terpilih';

  const tanggalCetak = getWIBDateTimeString();

  // Build breakdown table
  let breakdownRows = '';
  menuList.forEach((item, idx) => {
    const avgProfit = item.profit / item.qty;
    const percentage = totalProfit > 0 ? (item.profit / totalProfit * 100) : 0;
    const isTop = idx < 3;
    const badge = isTop ? ['ü•á','ü•à','ü•â'][idx] : '';
    
    breakdownRows += `
      <tr style="background:${isTop ? '#FFF8E6' : 'white'};">
        <td>${badge} <strong>${item.menu}</strong></td>
        <td class="pr-num">${item.qty} pcs</td>
        <td class="pr-num">${item.transaksi}x</td>
        <td class="pr-num"><strong>${formatRp(item.profit)}</strong></td>
        <td class="pr-num">${percentage.toFixed(1)}%</td>
        <td class="pr-num">${formatRp(avgProfit)}</td>
      </tr>`;
  });

  // Build transaksi table
  let transaksiRows = '';
  filtered.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(t => {
    const displayDate = parseWIBDate(t.tanggal).toLocaleDateString('id-ID', { timeZone: 'Asia/Jakarta' });
    transaksiRows += `
      <tr>
        <td>${displayDate}</td>
        <td>${t.menu}</td>
        <td class="pr-num">${t.qty} pcs</td>
        <td class="pr-num">${formatRp(t.hpp)}</td>
        <td class="pr-num">${formatRp(t.hargaJual)}</td>
        <td class="pr-num"><strong>${formatRp(t.profit)}</strong></td>
      </tr>`;
  });

  const printContent = `
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }
      body { font-family: Arial, sans-serif; color: #1A1A1A; font-size: 12px; }

      .doc-header { display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 3px solid #E03027; margin-bottom: 16px; }
      .brand { font-size: 18px; font-weight: 900; color: #E03027; }
      .brand-sub { font-size: 9px; color: #888; font-weight: 700; text-transform: uppercase; margin-top: 2px; }
      .doc-meta { text-align: right; }
      .doc-meta .meta-title { font-size: 14px; font-weight: 900; }
      .doc-meta .meta-sub { font-size: 9px; color: #888; margin-top: 2px; }

      .summary-bar { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 16px; }
      .sum-box { background: #FFF8F0; border: 2px solid #F0E0CC; border-radius: 8px; padding: 10px; text-align: center; }
      .sum-label { font-size: 8px; font-weight: 700; color: #888; text-transform: uppercase; display: block; }
      .sum-value { font-size: 14px; font-weight: 900; color: #E03027; display: block; margin-top: 3px; }

      h3 { font-size: 12px; font-weight: 900; color: #E03027; margin: 14px 0 6px; padding-bottom: 4px; border-bottom: 2px solid #F0E0CC; }
      h3:first-of-type { margin-top: 0; }
      
      table { width: 100%; border-collapse: collapse; margin-bottom: 4px; font-size: 10px; }
      thead tr { background: #F47C20 !important; color: white !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      thead th { padding: 6px 8px; font-size: 9px; font-weight: 700; text-transform: uppercase; }
      tbody tr:nth-child(even) { background: #FFF8F0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      tbody td { padding: 6px 8px; border-bottom: 1px solid #F0E0CC; }
      .pr-num { text-align: right; }
      .total-row td { background: #FFF3E0 !important; font-weight: 700; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

      .doc-footer { margin-top: 16px; padding-top: 8px; border-top: 2px solid #F0E0CC; display: flex; justify-content: space-between; font-size: 9px; color: #aaa; }
    </style>

    <div class="doc-header">
      <div>
        <div class="brand">üç± Kedai Heula</div>
        <div class="brand-sub">Laporan Penjualan</div>
      </div>
      <div class="doc-meta">
        <div class="meta-title">${periodeLabel}</div>
        <div class="meta-sub">${totalTransaksi} transaksi ¬∑ ${totalItem} pcs terjual</div>
      </div>
    </div>

    <div class="summary-bar">
      <div class="sum-box">
        <span class="sum-label">üí∞ Total Profit</span>
        <span class="sum-value">${formatRp(totalProfit)}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">üì¶ Total Transaksi</span>
        <span class="sum-value">${totalTransaksi}</span>
      </div>
      <div class="sum-box">
        <span class="sum-label">üç± Item Terjual</span>
        <span class="sum-value">${totalItem} pcs</span>
      </div>
    </div>

    <h3>üìä Breakdown per Menu</h3>
    <table>
      <thead>
        <tr>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">Transaksi</th>
          <th class="pr-num">Total Profit</th>
          <th class="pr-num">% Kontribusi</th>
          <th class="pr-num">Avg/Item</th>
        </tr>
      </thead>
      <tbody>
        ${breakdownRows}
        <tr class="total-row">
          <td><strong>Total</strong></td>
          <td class="pr-num"><strong>${totalItem} pcs</strong></td>
          <td class="pr-num"><strong>${totalTransaksi}x</strong></td>
          <td class="pr-num"><strong>${formatRp(totalProfit)}</strong></td>
          <td class="pr-num"><strong>100%</strong></td>
          <td class="pr-num">‚Äî</td>
        </tr>
      </tbody>
    </table>

    <h3>üìã Riwayat Transaksi</h3>
    <table>
      <thead>
        <tr>
          <th>Tanggal</th>
          <th>Menu</th>
          <th class="pr-num">Qty</th>
          <th class="pr-num">HPP</th>
          <th class="pr-num">Harga Jual</th>
          <th class="pr-num">Profit</th>
        </tr>
      </thead>
      <tbody>
        ${transaksiRows}
      </tbody>
    </table>

    <div class="doc-footer">
      <span>Kedai Heula ‚Äì Laporan Penjualan</span>
      <span>Dicetak: ${tanggalCetak}</span>
    </div>
  `;

  const printArea = document.getElementById('print-area');
  if (!printArea) {
    showToast('‚ùå Error: print-area tidak ditemukan');
    console.error('print-area element tidak ada');
    return;
  }
  
  printArea.innerHTML = printContent;
  
  const isTelegram = /telegram/i.test(navigator.userAgent.toLowerCase());
  const isMobile = isMobileOrTelegram();
  
  if (isMobile && isTelegram) {
    showToast('‚ÑπÔ∏è Export PDF: Gunakan Telegram Desktop atau screenshot halaman ini');
  } else {
    window.print();
  }
  
  } catch (error) {
    console.error('Error di exportLaporanPDF:', error);
    showToast('‚ùå Error: ' + error.message);
  }
}

// Init: sudah digabung di window.onload di atas
</script>
</body>
</html>
